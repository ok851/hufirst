<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>创建测试用例 - UI自动化测试平台</title>
    <!-- 内联基础样式，确保即使CDN失败也能有基本布局 -->
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f3f4f6;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .bg-white {
            background-color: white;
        }
        .p-6 {
            padding: 24px;
        }
        .rounded-lg {
            border-radius: 8px;
        }
        .shadow-md {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .text-xl {
            font-size: 1.25rem;
        }
        .font-semibold {
            font-weight: 600;
        }
        .mb-4 {
            margin-bottom: 16px;
        }
        .form-group {
            margin-bottom: 16px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .btn {
            display: inline-block;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-weight: 500;
            cursor: pointer;
        }
        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }
        .btn-secondary {
            background-color: #10b981;
            color: white;
        }
        .btn-danger {
            background-color: #ef4444;
            color: white;
        }
        .btn-outline {
            background-color: white;
            color: #333;
            border: 1px solid #ddd;
        }
        .grid {
            display: grid;
        }
        .grid-cols-1 {
            grid-template-columns: repeat(1, minmax(0, 1fr));
        }
        .md\:grid-cols-2 {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }
        .gap-4 {
            gap: 16px;
        }
        .mt-4 {
            margin-top: 16px;
        }
        .mb-6 {
            margin-bottom: 24px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #3b82f6;
            color: white;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .flex {
            display: flex;
        }
        .justify-between {
            justify-content: space-between;
        }
        .items-center {
            align-items: center;
        }
        .gap-2 {
            gap: 8px;
        }
        .bg-gradient-to-r {
            background: linear-gradient(to right, #3b82f6, #2563eb);
        }
        .text-white {
            color: white;
        }
        .px-6 {
            padding-left: 24px;
            padding-right: 24px;
        }
        .py-4 {
            padding-top: 16px;
            padding-bottom: 16px;
        }
        .py-6 {
            padding-top: 24px;
            padding-bottom: 24px;
        }
        .text-center {
            text-align: center;
        }
        .border-l-4 {
            border-left: 4px solid #3b82f6;
        }
        .project-selector {
            background-color: #dbeafe;
            border-left: 4px solid #3b82f6;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 24px;
        }
        .step-form {
            background-color: #dbeafe;
            border: 1px solid #3b82f6;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
        }
        .step-form.active {
            display: block;
        }
        .navigation {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-top: 32px;
            padding-top: 16px;
            border-top: 1px solid #ddd;
        }
        .section {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 24px;
            margin-bottom: 24px;
            border-left: 4px solid #3b82f6;
        }
        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }
        .step-form-row {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }
        .step-form-row.full-width {
            grid-template-columns: repeat(1, minmax(0, 1fr));
        }
        .max-w-7xl {
            max-width: 80rem;
        }
        .mx-auto {
            margin-left: auto;
            margin-right: auto;
        }
        .bg-white {
            background-color: white;
        }
        .rounded-xl {
            border-radius: 12px;
        }
        .shadow-lg {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .overflow-hidden {
            overflow: hidden;
        }
        .text-2xl {
            font-size: 1.5rem;
        }
        .font-bold {
            font-weight: 700;
        }
        .min-h-screen {
            min-height: 100vh;
        }
        .py-8 {
            padding-top: 32px;
            padding-bottom: 32px;
        }
        .px-4 {
            padding-left: 16px;
            padding-right: 16px;
        }
        .gap-2 {
            gap: 8px;
        }
        .gap-4 {
            gap: 16px;
        }
        .hover\:bg-gray-100:hover {
            background-color: #f3f4f6;
        }
        .hover\:bg-white\/30:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }
        .mb-8 {
            margin-bottom: 32px;
        }
        .pt-4 {
            padding-top: 16px;
        }
        .border-t {
            border-top: 1px solid #ddd;
        }
        .block {
            display: block;
        }
        .hidden {
            display: none;
        }
        .text-sm {
            font-size: 0.875rem;
        }
        .text-gray-700 {
            color: #374151;
        }
        .mb-1 {
            margin-bottom: 4px;
        }
        .focus\:outline-none:focus {
            outline: none;
        }
        .focus\:ring-2:focus {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
        }
        .focus\:ring-primary:focus {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
        }
        .focus\:border-transparent:focus {
            border-color: transparent;
        }
        .resize-vertical {
            resize: vertical;
        }
        .bg-blue-50 {
            background-color: #dbeafe;
        }
        .border {
            border: 1px solid #ddd;
        }
        .border-primary {
            border-color: #3b82f6;
        }
        .p-4 {
            padding: 16px;
        }
        .mt-4 {
            margin-top: 16px;
        }
        .text-lg {
            font-size: 1.125rem;
        }
        .text-primary {
            color: #3b82f6;
        }
        .step-row.editing {
            background-color: #fef3c7 !important;
        }
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        .btn-sm {
            padding: 4px 8px;
            font-size: 0.875rem;
        }
        .flex-wrap {
            flex-wrap: wrap;
        }
        .justify-center {
            justify-content: center;
        }
        .mt-8 {
            margin-top: 32px;
        }
        .border-gray-200 {
            border-color: #e5e7eb;
        }
    </style>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome CDN -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#10b981',
                        accent: '#8b5cf6',
                        danger: '#ef4444',
                        warning: '#f59e0b',
                    },
                    fontFamily: {
                        sans: ['Segoe UI', 'Tahoma', 'Geneva', 'Verdana', 'sans-serif'],
                    },
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 min-h-screen py-8 px-4">
    <div class="max-w-7xl mx-auto">
        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
            <!-- 导航栏 -->
            <nav class="bg-gradient-to-r from-primary to-blue-600 text-white px-6 py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <i class="fa fa-robot text-2xl"></i>
                        <h1 class="text-2xl font-bold">UI自动化测试平台</h1>
                    </div>
                    <div class="flex items-center gap-4">
                        <a href="/" class="btn bg-white text-primary hover:bg-gray-100">
                            <i class="fa fa-home"></i>
                            首页
                        </a>
                        <a href="/list_projects" class="btn bg-white/20 text-white hover:bg-white/30">
                            <i class="fa fa-folder"></i>
                            项目管理
                        </a>
                        <a href="/run-history" class="btn bg-white/20 text-white hover:bg-white/30">
                            <i class="fa fa-history"></i>
                            运行历史记录
                        </a>
                    </div>
                </div>
            </nav>
            
            <!-- 页面标题 -->
            <div class="bg-gradient-to-r from-primary to-blue-600 text-white px-6 py-6 text-center">
                <h1 class="text-2xl font-bold">创建测试用例</h1>
                <p class="mt-2 text-blue-100">定义测试步骤和验证逻辑</p>
            </div>
            
            <!-- 标题和描述编辑按钮 -->
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 id="currentCaseTitle" class="text-xl font-bold text-gray-800">未设置标题</h2>
                        <p id="currentCaseDescription" class="text-gray-600 mt-1">未设置描述</p>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="openTitleModal()">
                        <i class="fa fa-pencil"></i>
                        编辑标题和描述
                    </button>
                </div>
            </div>
            
            <!-- 主要内容 -->
            <div class="p-6">
                <form id="caseForm">
                    <!-- 项目选择器 -->
                    <div class="project-selector">
                        <div class="form-group">
                            <label for="projectSelect">选择项目 *</label>
                            <select id="projectSelect" name="project_id" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="">请选择项目</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- 基本信息 -->
                    <div class="section">
                        <div class="section-title">
                            <i class="fa fa-info-circle text-primary"></i>
                            1. 基本信息
                        </div>
                        <div class="form-group">
                            <label for="precondition">前置条件</label>
                            <textarea id="precondition" name="precondition" placeholder="请输入测试用例的前置条件，如：已登录系统、已打开特定页面等..." rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"></textarea>
                        </div>
                    </div>
                    

                    
                    <!-- 操作步骤 -->
                    <div class="section">
                        <div class="section-title">
                            <i class="fa fa-list-ol text-primary"></i>
                            3. 操作步骤
                        </div>
                        <button type="button" class="btn btn-secondary mb-4" onclick="showStepForm()">
                            <i class="fa fa-plus"></i>
                            添加步骤
                        </button>
                        
                        <!-- 步骤表单 -->
                        <div id="stepForm" class="step-form">
                            <h4 class="text-lg font-semibold text-primary mb-4">添加/编辑操作步骤</h4>
                            <div class="step-form-row">
                                <div>
                                    <label for="stepAction">操作方式 *</label>
                                    <select id="stepAction" onchange="updateStepFormFields()" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                        <option value="">请选择操作方式</option>
                                        <option value="input">输入</option>
                                        <option value="click">点击</option>
                                        <option value="swipe">滑动</option>
                                        <option value="navigate">导航</option>
                                        <option value="extract_text">提取文本</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="stepPageName">页面名称</label>
                                    <input type="text" id="stepPageName" placeholder="请输入页面名称" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                </div>
                            </div>
                            
                            <!-- 元素定位字段 -->
                            <div id="locatorFields" class="step-form-row">
                                <div>
                                    <label for="stepLocatorMethod">元素定位方法 *</label>
                                    <select id="stepLocatorMethod" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                        <option value="css">CSS选择器</option>
                                        <option value="xpath">XPath</option>
                                        <option value="id">ID</option>
                                        <option value="name">Name</option>
                                        <option value="class">Class</option>
                                        <option value="text">文本</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="stepElementName">元素定位值 *</label>
                                    <input type="text" id="stepElementName" placeholder="请输入元素的定位值（如ID、class、name等）" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                </div>
                            </div>
                            
                            <!-- 输入值/预期结果字段 -->
                            <div id="inputValueField" class="step-form-row" style="display: none;">
                                <div>
                                    <label for="stepInputValue">输入值/预期结果</label>
                                    <input type="text" id="stepInputValue" placeholder="请输入要输入的值或预期的文本结果" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                </div>
                            </div>
                            
                            <!-- 验证方式字段 -->
                            <div id="verifyTypeField" class="step-form-row" style="display: none;">
                                <div>
                                    <label for="stepVerifyType">验证方式</label>
                                    <select id="stepVerifyType" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                        <option value="equals">等于</option>
                                        <option value="contains">包含</option>
                                        <option value="partial">部分等于</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- 滑动字段 -->
                            <div id="swipeFields" class="step-form-row" style="display: none;">
                                <div>
                                    <label for="stepSwipeX">X轴偏移量</label>
                                    <input type="text" id="stepSwipeX" placeholder="请输入X轴偏移量" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                </div>
                                <div>
                                    <label for="stepSwipeY">Y轴偏移量</label>
                                    <input type="text" id="stepSwipeY" placeholder="请输入Y轴偏移量" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                </div>
                            </div>
                            
                            <!-- URL字段 -->
                            <div id="urlField" class="step-form-row" style="display: none;">
                                <div>
                                    <label for="stepUrl">URL地址</label>
                                    <input type="text" id="stepUrl" placeholder="请输入URL地址" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                </div>
                            </div>
                            
                            <!-- 步骤描述 -->
                            <div class="step-form-row full-width">
                                <div>
                                    <label for="stepDescription">步骤描述</label>
                                    <input type="text" id="stepDescription" placeholder="请输入步骤描述" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                </div>
                            </div>
                            
                            <!-- 操作按钮 -->
                            <div class="flex justify-end gap-2 mt-4">
                                <button type="button" class="btn btn-primary" onclick="saveStep()">
                                    <i class="fa fa-save"></i>
                                    保存步骤
                                </button>
                                <button type="button" class="btn btn-outline" onclick="hideStepForm()">
                                    <i class="fa fa-times"></i>
                                    取消
                                </button>
                            </div>
                        </div>
                        
                        <!-- 步骤表格 -->
                        <table class="steps-table" id="stepsTable">
                            <thead>
                                <tr>
                                    <th style="width: 60px;">序号</th>
                                    <th style="width: 120px;">操作方式</th>
                                    <th style="width: 140px;">页面名称</th>
                                    <th style="width: 140px;">元素定位方法</th>
                                    <th style="width: 180px;">元素定位值</th>
                                    <th style="width: 200px;">输入值</th>
                                    <th>步骤描述</th>
                                    <th style="width: 120px;">操作</th>
                                </tr>
                            </thead>
                            <tbody id="stepsTableBody">
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- 预期结果 -->
                    <div class="section">
                        <div class="section-title">
                            <i class="fa fa-bullseye text-primary"></i>
                            4. 预期结果
                        </div>
                        <div class="form-group">
                            <label for="expectedResult">预期结果</label>
                            <textarea id="expectedResult" name="expectedResult" placeholder="请输入测试用例的预期结果，如：页面跳转成功、显示特定提示信息等..." rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"></textarea>
                        </div>
                    </div>
                    
                    <!-- 导航按钮 -->
                    <div class="navigation">
                        <button type="submit" class="btn btn-secondary">
                            <i class="fa fa-check"></i>
                            保存
                        </button>
                        <a href="/list_projects" class="btn btn-outline">
                            <i class="fa fa-arrow-left"></i>
                            返回项目列表
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

<script>
    let steps = [];
    let editingStepIndex = -1;
    let currentProjectId = null;
    let currentCaseId = null;
    let caseTitle = '';
    let caseDescription = '';

    async function loadProjects() {
        try {
            console.log('开始加载项目数据...');
            const response = await fetch('/api/projects');
            console.log('API响应状态:', response.status);
            
            if (!response.ok) {
                throw new Error(`API请求失败: ${response.status} ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log('项目数据:', data);
            
            const projectSelect = document.getElementById('projectSelect');
            projectSelect.innerHTML = '<option value="">请选择项目</option>';
            
            if (data.projects && data.projects.length > 0) {
                data.projects.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.id;
                    option.textContent = project.name;
                    projectSelect.appendChild(option);
                });
                console.log('项目加载成功，共加载', data.projects.length, '个项目');
            } else {
                console.log('暂无项目数据');
                alert('暂无项目，请先创建项目');
                window.location.href = '/list_projects';
            }
        } catch (error) {
            console.error('加载项目失败:', error);
            alert('加载项目失败: ' + error.message);
        }
    }

    async function loadTestCase(caseId) {
        try {
            console.log('加载测试用例详情:', caseId);
            
            // 获取用例基本信息
            const caseResponse = await fetch(`/api/cases/${caseId}`);
            const caseData = await caseResponse.json();
            
            if (caseData.test_case) {
                const testCase = caseData.test_case;
                
                // 填充表单数据
                document.getElementById('projectSelect').value = testCase.project_id;
                caseTitle = testCase.name;
                caseDescription = testCase.description || '';
                document.getElementById('currentCaseTitle').textContent = caseTitle || '未设置标题';
                document.getElementById('currentCaseDescription').textContent = caseDescription || '未设置描述';
                document.getElementById('precondition').value = testCase.precondition || '';
                document.getElementById('expectedResult').value = testCase.expected_result || '';
                
                // 获取用例步骤
                const stepsResponse = await fetch(`/api/cases/${caseId}/steps`);
                const stepsData = await stepsResponse.json();
                
                if (stepsData.steps && stepsData.steps.length > 0) {
                    steps = [];
                    stepsData.steps.forEach(step => {
                        steps.push({
                            action: step.action,
                            page_name: step.page_name || '',
                            locator_method: step.selector_type || 'css',
                            element_name: step.selector_value || '',
                            input_value: step.input_value || '',
                            swipe_x: step.swipe_x || '',
                            swipe_y: step.swipe_y || '',
                            url: step.url || '',
                            description: step.description || ''
                        });
                    });
                    renderSteps();
                }
                
                currentCaseId = caseId;
                console.log('测试用例加载成功');
            }
        } catch (error) {
            console.error('加载测试用例失败:', error);
            alert('加载测试用例失败: ' + error.message);
        }
    }

    function showStepForm() {
        document.getElementById('stepForm').classList.add('active');
        clearStepForm();
    }

    function hideStepForm() {
        document.getElementById('stepForm').classList.remove('active');
        editingStepIndex = -1;
        clearStepForm();
    }

    function clearStepForm() {
        document.getElementById('stepAction').value = '';
        document.getElementById('stepPageName').value = '';
        document.getElementById('stepLocatorMethod').value = 'css';
        document.getElementById('stepElementName').value = '';
        document.getElementById('stepInputValue').value = '';
        document.getElementById('stepSwipeX').value = '';
        document.getElementById('stepSwipeY').value = '';
        document.getElementById('stepUrl').value = '';
        document.getElementById('stepDescription').value = '';
        updateStepFormFields();
    }

    function updateStepFormFields() {
        const action = document.getElementById('stepAction').value;
        
        document.getElementById('inputValueField').style.display = 'none';
        document.getElementById('swipeFields').style.display = 'none';
        document.getElementById('urlField').style.display = 'none';
        document.getElementById('locatorFields').style.display = 'none'; // 默认隐藏元素定位字段
        document.getElementById('verifyTypeField').style.display = 'none'; // 默认隐藏验证方式字段
        
        if (action === 'input' || action === 'click' || action === 'extract_text') {
            document.getElementById('locatorFields').style.display = 'grid'; // 点击/输入/提取文本操作显示定位字段
            if (action === 'input' || action === 'extract_text') {
                document.getElementById('inputValueField').style.display = 'grid'; // 输入和提取文本操作显示输入值/预期结果字段
                if (action === 'extract_text') {
                    document.getElementById('verifyTypeField').style.display = 'grid'; // 提取文本操作显示验证方式字段
                }
            }
        } else if (action === 'swipe') {
            document.getElementById('swipeFields').style.display = 'grid';
        } else if (action === 'navigate') {
            document.getElementById('urlField').style.display = 'grid';
        }
    }

    function saveStep() {
        const action = document.getElementById('stepAction').value;
        const pageName = document.getElementById('stepPageName').value;
        const locatorMethod = document.getElementById('stepLocatorMethod').value;
        const elementName = document.getElementById('stepElementName').value;
        const inputValue = document.getElementById('stepInputValue').value;
        const swipeX = document.getElementById('stepSwipeX').value;
        const swipeY = document.getElementById('stepSwipeY').value;
        const url = document.getElementById('stepUrl').value;
        const verifyType = document.getElementById('stepVerifyType').value;
        const description = document.getElementById('stepDescription').value;

        if (!action) {
            alert('请选择操作方式');
            return;
        }

        // 添加点击/输入/提取文本操作时元素定位值的必填验证
        if ((action === 'click' || action === 'input' || action === 'extract_text') && !elementName) {
            alert('点击、输入或提取文本操作必须填写元素定位值');
            return;
        }

        // 输入操作时输入值的验证
        if (action === 'input' && !inputValue) {
            alert('输入操作必须填写输入值');
            return;
        }

        // 提取文本操作时预期结果的验证
        if (action === 'extract_text' && !inputValue) {
            alert('提取文本操作必须填写预期的文本结果');
            return;
        }

        // 滑动操作时坐标的验证
        if (action === 'swipe') {
            if (!swipeX || !swipeY) {
                alert('滑动操作必须填写X轴和Y轴偏移量');
                return;
            }
        }

        // 导航操作时URL的验证
        if (action === 'navigate' && !url) {
            alert('导航操作必须填写URL地址');
            return;
        }

        const step = {
            action: action,
            page_name: pageName,
            locator_method: locatorMethod,
            element_name: elementName,
            input_value: inputValue,
            swipe_x: swipeX,
            swipe_y: swipeY,
            url: url,
            verify_type: verifyType,
            description: description
        };

        if (editingStepIndex >= 0) {
            steps[editingStepIndex] = step;
            editingStepIndex = -1;
        } else {
            steps.push(step);
        }

        renderSteps();
        hideStepForm();
    }

    function renderSteps() {
        const tbody = document.getElementById('stepsTableBody');
        tbody.innerHTML = '';

        steps.forEach((step, index) => {
            const row = document.createElement('tr');
            row.className = 'step-row';
            
            let displayValue = '-';
            if (step.action === 'input') {
                displayValue = step.input_value || '-';
            } else if (step.action === 'swipe') {
                displayValue = `X: ${step.swipe_x || '0'}, Y: ${step.swipe_y || '0'}`;
            } else if (step.action === 'navigate') {
                displayValue = step.url || '-';
            } else if (step.action === 'extract_text') {
                displayValue = step.input_value || '-';
            }
            
            row.innerHTML = `
                <td>${index + 1}</td>
                <td>${step.action}</td>
                <td>${step.page_name || '-'}</td>
                <td>${step.locator_method || '-'}</td>
                <td>${step.element_name || '-'}</td>
                <td>${displayValue}</td>
                <td>${step.description || '-'}</td>
                <td>
                    <div class="action-buttons">
                        <button type="button" class="btn btn-sm btn-primary" onclick="editStep(${index})">编辑</button>
                        <button type="button" class="btn btn-sm btn-danger" onclick="deleteStep(${index})">删除</button>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        });
        

    }
    

    
    // 格式化日期时间
    function formatDateTime(dateTimeStr) {
        const date = new Date(dateTimeStr);
        return date.toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
    }

    function editStep(index) {
        const step = steps[index];
        document.getElementById('stepAction').value = step.action;
        document.getElementById('stepPageName').value = step.page_name || '';
        document.getElementById('stepLocatorMethod').value = step.locator_method || 'css';
        document.getElementById('stepElementName').value = step.element_name || '';
        document.getElementById('stepInputValue').value = step.input_value || '';
        document.getElementById('stepSwipeX').value = step.swipe_x || '';
        document.getElementById('stepSwipeY').value = step.swipe_y || '';
        document.getElementById('stepUrl').value = step.url || '';
        document.getElementById('stepDescription').value = step.description || '';
        
        updateStepFormFields();
        editingStepIndex = index;
        document.getElementById('stepForm').classList.add('active');
    }

    function deleteStep(index) {
        if (confirm('确定要删除这个步骤吗？')) {
            steps.splice(index, 1);
            renderSteps();
        }
    }

    // 模态框相关函数
    function openTitleModal() {
        document.getElementById('modalCaseTitle').value = caseTitle;
        document.getElementById('modalCaseDescription').value = caseDescription;
        document.getElementById('titleModal').classList.remove('hidden');
    }

    function closeTitleModal() {
        document.getElementById('titleModal').classList.add('hidden');
    }

    // 标题表单提交
    document.addEventListener('DOMContentLoaded', function() {
        if (document.getElementById('titleForm')) {
            document.getElementById('titleForm').addEventListener('submit', function(e) {
                e.preventDefault();
                caseTitle = document.getElementById('modalCaseTitle').value;
                caseDescription = document.getElementById('modalCaseDescription').value;
                
                document.getElementById('currentCaseTitle').textContent = caseTitle || '未设置标题';
                document.getElementById('currentCaseDescription').textContent = caseDescription || '未设置描述';
                
                closeTitleModal();
            });
        }
        console.log('DOM加载完成，开始初始化页面...');
        
        document.getElementById('caseForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            console.log('=== 开始提交表单 ===');

            const projectId = document.getElementById('projectSelect').value;
            const precondition = document.getElementById('precondition').value;
            const expectedResult = document.getElementById('expectedResult').value;

            console.log('表单数据:', {
                projectId: projectId,
                caseTitle: caseTitle,
                caseDescription: caseDescription,
                precondition: precondition,
                expectedResult: expectedResult,
                stepsCount: steps.length
            });

            if (!projectId) {
                alert('请选择项目');
                return;
            }

            if (!caseTitle) {
                alert('请输入用例标题');
                return;
            }

            try {
                console.log('发送创建/更新用例请求...');
                
                let response, data;
                if (currentCaseId) {
                    // 更新用例
                    response = await fetch(`/api/cases/${currentCaseId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            name: caseTitle,
                            url: '',
                            description: caseDescription,
                            precondition: precondition,
                            expected_result: expectedResult
                        })
                    });
                    data = await response.json();
                    
                    if (data.success) {
                        // 删除原有步骤
                        await fetch(`/api/cases/${currentCaseId}/steps`, {
                            method: 'DELETE'
                        });
                        
                        // 添加新步骤
                        for (let i = 0; i < steps.length; i++) {
                            const step = steps[i];
                            let stepData = {
                                case_id: currentCaseId,
                                action: step.action,
                                selector_type: step.locator_method,
                                selector_value: step.element_name || '',
                                description: step.description || '',
                                step_order: i + 1,
                                page_name: step.page_name || ''
                            };
                            
                            if (step.action === 'input') {
                                stepData.input_value = step.input_value || '';
                            } else if (step.action === 'swipe') {
                                stepData.swipe_x = step.swipe_x || '0';
                                stepData.swipe_y = step.swipe_y || '0';
                            } else if (step.action === 'navigate') {
                                stepData.url = step.url || '';
                            } else if (step.action === 'extract_text') {
                                stepData.input_value = step.input_value || '';
                            }
                            
                            await fetch('/api/steps', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(stepData)
                            });
                        }

                        alert('测试用例更新成功！');
                        window.location.href = '/list_projects';
                    } else {
                        alert('更新失败: ' + (data.error || '未知错误'));
                    }
                } else {
                    // 创建用例
                    response = await fetch('/api/cases', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            project_id: parseInt(projectId),
                            name: caseTitle,
                            url: '',
                            description: caseDescription,
                            precondition: precondition,
                            expected_result: expectedResult
                        })
                    });

                    console.log('响应状态:', response.status);
                    data = await response.json();
                    console.log('响应数据:', data);

                    if (data.success) {
                        const caseId = data.case_id;
                        
                        for (let i = 0; i < steps.length; i++) {
                            const step = steps[i];
                            let stepData = {
                                case_id: caseId,
                                action: step.action,
                                selector_type: step.locator_method,
                                selector_value: step.element_name || '',
                                description: step.description || '',
                                step_order: i + 1,
                                page_name: step.page_name || ''
                            };
                            
                            if (step.action === 'input') {
                                stepData.input_value = step.input_value || '';
                            } else if (step.action === 'swipe') {
                                stepData.swipe_x = step.swipe_x || '0';
                                stepData.swipe_y = step.swipe_y || '0';
                            } else if (step.action === 'navigate') {
                                stepData.url = step.url || '';
                            }
                            
                            await fetch('/api/steps', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(stepData)
                            });
                        }

                        alert('测试用例创建成功！用例ID: ' + caseId);
                        window.location.href = '/list_projects';
                    } else {
                        alert('创建失败: ' + (data.error || '未知错误'));
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                alert('创建测试用例时发生错误: ' + error.message);
            }
        });

        // 加载项目数据
        console.log('调用loadProjects函数...');
        loadProjects();
        
        // 处理URL参数
        console.log('处理URL参数...');
        const urlParams = new URLSearchParams(window.location.search);
        const projectId = urlParams.get('project_id');
        if (projectId) {
            console.log('URL中包含project_id参数:', projectId);
            setTimeout(() => {
                document.getElementById('projectSelect').value = projectId;
                console.log('已设置项目选择器值为:', projectId);
            }, 500);
        }
        
        // 检查是否有case_id参数，如果有则加载测试用例
        const caseId = urlParams.get('case_id');
        if (caseId) {
            console.log('URL中包含case_id参数:', caseId);
            loadTestCase(caseId);
        }
        
        console.log('页面初始化完成');
    });
</script>
    <!-- 标题和描述编辑模态框 -->
    <div id="titleModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">编辑用例标题和描述</h3>
                <button type="button" class="text-gray-400 hover:text-gray-600" onclick="closeTitleModal()">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <form id="titleForm">
                <div class="form-group mb-4">
                    <label for="modalCaseTitle" class="block text-sm font-medium text-gray-700 mb-1">用例标题 *</label>
                    <input type="text" id="modalCaseTitle" required placeholder="请输入用例标题" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                <div class="form-group mb-4">
                    <label for="modalCaseDescription" class="block text-sm font-medium text-gray-700 mb-1">用例描述</label>
                    <textarea id="modalCaseDescription" placeholder="请输入测试用例的详细描述..." rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"></textarea>
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" class="btn btn-outline" onclick="closeTitleModal()">取消</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>
</body>
</html>