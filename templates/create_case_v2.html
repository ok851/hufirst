<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>创建测试用例 - UI自动化测试平台</title>
    <!-- 内联基础样式，确保即使CDN失败也能有基本布局 -->
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f3f4f6;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .bg-white {
            background-color: white;
        }
        .p-6 {
            padding: 24px;
        }
        .rounded-lg {
            border-radius: 8px;
        }
        .shadow-md {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .text-xl {
            font-size: 1.25rem;
        }
        .font-semibold {
            font-weight: 600;
        }
        .mb-4 {
            margin-bottom: 16px;
        }
        .form-group {
            margin-bottom: 16px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .btn {
            display: inline-block;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-weight: 500;
            cursor: pointer;
        }
        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }
        .btn-secondary {
            background-color: #10b981;
            color: white;
        }
        .btn-danger {
            background-color: #ef4444;
            color: white;
        }
        .btn-outline {
            background-color: white;
            color: #333;
            border: 1px solid #ddd;
        }
        .grid {
            display: grid;
        }
        .grid-cols-1 {
            grid-template-columns: repeat(1, minmax(0, 1fr));
        }
        .md\:grid-cols-2 {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }
        .gap-4 {
            gap: 16px;
        }
        .mt-4 {
            margin-top: 16px;
        }
        .mb-6 {
            margin-bottom: 24px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #3b82f6;
            color: white;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .flex {
            display: flex;
        }
        .justify-between {
            justify-content: space-between;
        }
        .items-center {
            align-items: center;
        }
        .gap-2 {
            gap: 8px;
        }
        .bg-gradient-to-r {
            background: linear-gradient(to right, #3b82f6, #2563eb);
        }
        .text-white {
            color: white;
        }
        .px-6 {
            padding-left: 24px;
            padding-right: 24px;
        }
        .py-4 {
            padding-top: 16px;
            padding-bottom: 16px;
        }
        .py-6 {
            padding-top: 24px;
            padding-bottom: 24px;
        }
        .text-center {
            text-align: center;
        }
        .border-l-4 {
            border-left: 4px solid #3b82f6;
        }
        .project-selector {
            background-color: #dbeafe;
            border-left: 4px solid #3b82f6;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 24px;
        }
        .step-form {
            background-color: #dbeafe;
            border: 1px solid #3b82f6;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
        }
        .step-form.active {
            display: block;
        }
        .navigation {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-top: 32px;
            padding-top: 16px;
            border-top: 1px solid #ddd;
        }
        .section {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 24px;
            margin-bottom: 24px;
            border-left: 4px solid #3b82f6;
        }
        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }
        .step-form-row {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }
        .step-form-row.full-width {
            grid-template-columns: repeat(1, minmax(0, 1fr));
        }
        .max-w-7xl {
            max-width: 80rem;
        }
        .mx-auto {
            margin-left: auto;
            margin-right: auto;
        }
        .bg-white {
            background-color: white;
        }
        .rounded-xl {
            border-radius: 12px;
        }
        .shadow-lg {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .overflow-hidden {
            overflow: hidden;
        }
        .text-2xl {
            font-size: 1.5rem;
        }
        .font-bold {
            font-weight: 700;
        }
        .min-h-screen {
            min-height: 100vh;
        }
        .py-8 {
            padding-top: 32px;
            padding-bottom: 32px;
        }
        .px-4 {
            padding-left: 16px;
            padding-right: 16px;
        }
        .gap-2 {
            gap: 8px;
        }
        .gap-4 {
            gap: 16px;
        }
        .hover\:bg-gray-100:hover {
            background-color: #f3f4f6;
        }
        .hover\:bg-white\/30:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }
        .mb-8 {
            margin-bottom: 32px;
        }
        .pt-4 {
            padding-top: 16px;
        }
        .border-t {
            border-top: 1px solid #ddd;
        }
        .block {
            display: block;
        }
        .hidden {
            display: none;
        }
        .text-sm {
            font-size: 0.875rem;
        }
        .text-gray-700 {
            color: #374151;
        }
        .mb-1 {
            margin-bottom: 4px;
        }
        .focus\:outline-none:focus {
            outline: none;
        }
        .focus\:ring-2:focus {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
        }
        .focus\:ring-primary:focus {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
        }
        .focus\:border-transparent:focus {
            border-color: transparent;
        }
        .resize-vertical {
            resize: vertical;
        }
        .bg-blue-50 {
            background-color: #dbeafe;
        }
        .border {
            border: 1px solid #ddd;
        }
        .border-primary {
            border-color: #3b82f6;
        }
        .p-4 {
            padding: 16px;
        }
        .mt-4 {
            margin-top: 16px;
        }
        .text-lg {
            font-size: 1.125rem;
        }
        .text-primary {
            color: #3b82f6;
        }
        .step-row.editing {
            background-color: #fef3c7 !important;
        }
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        .btn-sm {
            padding: 4px 8px;
            font-size: 0.875rem;
        }
        .flex-wrap {
            flex-wrap: wrap;
        }
        .justify-center {
            justify-content: center;
        }
        .mt-8 {
            margin-top: 32px;
        }
        .border-gray-200 {
            border-color: #e5e7eb;
        }
    </style>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome CDN -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#10b981',
                        accent: '#8b5cf6',
                        danger: '#ef4444',
                        warning: '#f59e0b'
                    },
                    fontFamily: {
                        sans: ['Segoe UI', 'Tahoma', 'Geneva', 'Verdana', 'sans-serif']
                    },
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 min-h-screen py-8 px-4">
    <div class="max-w-7xl mx-auto">
        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
            <!-- 导航栏 -->
            <nav class="bg-gradient-to-r from-primary to-blue-600 text-white px-6 py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <i class="fa fa-robot text-2xl"></i>
                        <h1 class="text-2xl font-bold">UI自动化测试平台</h1>
                    </div>
                    <div class="flex items-center gap-4">
                        <a href="/" class="btn bg-white text-primary hover:bg-gray-100">
                            <i class="fa fa-home"></i>
                            首页
                        </a>
                        <a href="/list_projects" class="btn bg-white/20 text-white hover:bg-white/30">
                            <i class="fa fa-folder"></i>
                            项目管理
                        </a>
                        <a href="/run-history" class="btn bg-white/20 text-white hover:bg-white/30">
                            <i class="fa fa-history"></i>
                            运行历史记录
                        </a>
                    </div>
                </div>
            </nav>
            
            <!-- 页面标题 -->
            <div class="bg-gradient-to-r from-primary to-blue-600 text-white px-6 py-6 text-center">
                <h1 class="text-2xl font-bold">创建测试用例</h1>
                <p class="mt-2 text-blue-100">定义测试步骤和验证逻辑</p>
            </div>
            
            <!-- 标题和描述编辑按钮 -->
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 id="currentCaseTitle" class="text-xl font-bold text-gray-800">未设置标题</h2>
                        <p id="currentCaseDescription" class="text-gray-600 mt-1">未设置描述</p>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="openTitleModal()">
                        <i class="fa fa-pencil"></i>
                        编辑标题和描述
                    </button>
                </div>
            </div>
            
            <!-- 主要内容 -->
            <div class="p-6">
                <form id="caseForm">
                    <!-- 项目选择器 -->
                    <div class="project-selector">
                        <div class="form-group flex items-center justify-between">
                            <label for="projectSelect">选择项目 *</label>
                            <button type="button" id="refreshProjectsBtn" class="btn btn-sm btn-outline">
                                <i class="fa fa-refresh"></i>
                                刷新
                            </button>
                        </div>
                        <div class="relative">
                            <select id="projectSelect" name="project_id" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="">请选择项目</option>
                            </select>
                            <div id="projectLoading" style="display: none;" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                        <div id="projectError" class="text-red-500 text-sm mt-1" style="display: none;"></div>
                    </div>
                    <!-- 用例名称和描述编辑提示 -->
                    <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-md">
                        <h3 class="font-medium text-blue-800 mb-2">用例名称和描述</h3>
                        <p class="text-blue-700 mb-3">点击页面顶部的"编辑标题和描述"按钮来设置测试用例的名称和描述。</p>
                    </div>


                    <!-- 导航按钮 -->
                    <div class="navigation">
                        <button type="submit" class="btn btn-secondary">
                            <i class="fa fa-check"></i>
                            保存
                        </button>
                        <a href="/list_projects" class="btn btn-outline">
                            <i class="fa fa-arrow-left"></i>
                            返回项目列表
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

<script>
    let steps = [];
    let editingStepIndex = -1;
    let currentProjectId = null;
    let currentCaseId = null;
    let caseTitle = '';
    let caseDescription = '';


    async function loadProjects() {
        // 显示加载状态
        const projectSelect = document.getElementById('projectSelect');
        const projectLoading = document.getElementById('projectLoading');
        const projectError = document.getElementById('projectError');
        const refreshBtn = document.getElementById('refreshProjectsBtn');
        
        if (projectSelect && projectLoading && projectError) {
            // 禁用选择器和刷新按钮
            projectSelect.disabled = true;
            if (refreshBtn) refreshBtn.disabled = true;
            
            // 显示加载动画，隐藏错误信息
            projectLoading.style.display = 'block';
            projectError.style.display = 'none';
            
            try {
                console.log('开始加载项目数据...');
                const response = await fetch('/api/projects');
                console.log('API响应状态:', response.status);
                
                if (!response.ok) {
                    throw new Error(`API请求失败: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('项目数据:', data);
                
                // 清空现有选项
                projectSelect.innerHTML = '<option value="">请选择项目</option>';
                
                if (data && data.projects && data.projects.length > 0) {
                    data.projects.forEach(project => {
                        const option = document.createElement('option');
                        option.value = project.id;
                        option.textContent = project.name;
                        projectSelect.appendChild(option);
                    });
                    console.log('项目加载成功，共加载', data.projects.length, '个项目');
                } else {
                    console.log('暂无项目数据');
                    // 不直接跳转，而是显示提示
                    projectError.textContent = '暂无项目数据，请先创建项目';
                    projectError.style.display = 'block';
                }
            } catch (error) {
                console.error('加载项目失败:', error);
                projectError.textContent = '加载项目失败: ' + error.message;
                projectError.style.display = 'block';
            } finally {
                // 隐藏加载动画，启用选择器和刷新按钮
                projectLoading.style.display = 'none';
                projectSelect.disabled = false;
                if (refreshBtn) refreshBtn.disabled = false;
            }
        }
    }

    async function loadTestCase(caseId) {
        try {
            console.log('加载测试用例详情:', caseId);
            
            // 获取用例基本信息
            const caseResponse = await fetch(`/api/cases/${caseId}`);
            const caseData = await caseResponse.json();
            
            if (caseData.test_case) {
                const testCase = caseData.test_case;
                
                // 填充表单数据
                document.getElementById('projectSelect').value = testCase.project_id;
                caseTitle = testCase.name;
                caseDescription = testCase.description || '';
                document.getElementById('currentCaseTitle').textContent = caseTitle || '未设置标题';
                document.getElementById('currentCaseDescription').textContent = caseDescription || '未设置描述';
                
                // 获取用例步骤
                const stepsResponse = await fetch(`/api/cases/${caseId}/steps`);
                const stepsData = await stepsResponse.json();
                
                if (stepsData.steps && stepsData.steps.length > 0) {
                    steps = [];
                    stepsData.steps.forEach(step => {
                        steps.push({
                            action: step.action,
                            page_name: step.page_name || '',
                            locator_method: step.selector_type || 'css',
                            element_name: step.selector_value || '',
                            input_value: step.input_value || '',
                            swipe_x: step.swipe_x || '',
                            swipe_y: step.swipe_y || '',
                            url: step.url || '',
                            description: step.description || ''
                        });
                    });
                    renderSteps();
                }
                
                currentCaseId = caseId;
                console.log('测试用例加载成功');
            }
        } catch (error) {
            console.error('加载测试用例失败:', error);
            alert('加载测试用例失败: ' + error.message);
        }
    }

    function showStepForm() {
        const stepForm = document.getElementById('stepForm');
        if (stepForm) {
            stepForm.classList.add('active');
            clearStepForm();
            // 初始化表单字段显示，包括可视化选择按钮
            updateStepFormFields();
        }
    }

    function hideStepForm() {
        const stepForm = document.getElementById('stepForm');
        if (stepForm) {
            stepForm.classList.remove('active');
            editingStepIndex = -1;
            clearStepForm();
        }
    }

    function clearStepForm() {
        // 保留当前的操作方式，不重置stepAction的值
        const elementsToClear = [
            { id: 'stepPageName', value: '' },
            { id: 'stepLocatorMethod', value: 'css' },
            { id: 'stepElementName', value: '' },
            { id: 'stepInputValue', value: '' },
            { id: 'stepSwipeX', value: '' },
            { id: 'stepSwipeY', value: '' },
            { id: 'stepUrl', value: '' },
            { id: 'stepDescription', value: '' }
        ];
        
        elementsToClear.forEach(elementInfo => {
            const element = document.getElementById(elementInfo.id);
            if (element) {
                element.value = elementInfo.value;
            }
        });
        // 不调用updateStepFormFields，避免重置字段可见性
    }

    function updateStepFormFields() {
        const action = document.getElementById('stepAction')?.value || '';
        console.log('updateStepFormFields called with action:', action);
        
        // 默认隐藏除可视化选择字段外的所有字段
        const fields = [
            'inputValueField', 
            'swipeFields', 
            'urlField', 
            'locatorFields', 
            'verifyTypeField'
        ];
        
        fields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                field.style.display = 'none';
            }
        });
        
        // 显示/隐藏开始选择按钮 - 对所有需要元素定位的操作都显示
        const startSelectBtn = document.getElementById('startSelectBtn');
        const stopSelectBtn = document.getElementById('stopSelectBtn');
        if (startSelectBtn && stopSelectBtn) {
            if (action === 'extract_text' || action === 'click' || action === 'input') {
                startSelectBtn.style.display = 'inline-block';
                console.log('显示开始选择按钮');
            } else {
                startSelectBtn.style.display = 'none';
                stopSelectBtn.style.display = 'none';
                console.log('隐藏开始选择按钮');
            }
        }
        
        // 根据操作类型显示相应字段
        if (action === 'input' || action === 'click' || action === 'extract_text') {
            console.log('显示定位字段');
            const locatorFields = document.getElementById('locatorFields');
            if (locatorFields) {
                locatorFields.style.display = 'grid';
            }
            
            if (action === 'input' || action === 'extract_text') {
                console.log('显示输入值字段');
                const inputValueField = document.getElementById('inputValueField');
                if (inputValueField) {
                    inputValueField.style.display = 'grid';
                }
                
                if (action === 'extract_text') {
                    console.log('显示验证方式字段');
                    const verifyTypeField = document.getElementById('verifyTypeField');
                    if (verifyTypeField) {
                        verifyTypeField.style.display = 'grid';
                    }
                }
            }
        } else if (action === 'swipe') {
            console.log('显示滑动字段');
            const swipeFields = document.getElementById('swipeFields');
            if (swipeFields) {
                swipeFields.style.display = 'grid';
            }
        } else if (action === 'navigate') {
            console.log('显示URL字段');
            const urlField = document.getElementById('urlField');
            if (urlField) {
                urlField.style.display = 'grid';
            }
        }
    }
    
    // 可视化选择功能
    let isSelecting = false;
    
    function startVisualSelection() {
        isSelecting = true;
        
        // 更新UI状态，只在元素存在时操作
        const startSelectBtn = document.getElementById('startSelectBtn');
        const stopSelectBtn = document.getElementById('stopSelectBtn');
        const selectionStatus = document.getElementById('selectionStatus');
        
        if (startSelectBtn) {
            startSelectBtn.style.display = 'none';
        }
        if (stopSelectBtn) {
            stopSelectBtn.style.display = 'block';
        }
        if (selectionStatus) {
            selectionStatus.style.display = 'block';
        }
        
        // 查找当前用例中的导航步骤，获取URL
        const navigateStep = steps.find(step => step.action === 'navigate');
        // 导航URL可能存储在url属性或input_value属性中，同时检查两者
        const targetUrl = navigateStep ? (navigateStep.url || navigateStep.input_value || '') : '';
        console.log('提取到的导航URL:', targetUrl, 'from step:', navigateStep);
        
        // 调用后端API启动可视化选择，并传递导航URL
        console.log('正在启动可视化选择，目标URL:', targetUrl);
        fetch('/api/start_visual_selection', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ url: targetUrl })
        })
        .then(response => {
            console.log('启动选择响应状态:', response.status);
            console.log('响应类型:', response.headers.get('content-type'));
            if (!response.ok) {
                throw new Error('启动选择失败，状态码: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                console.log('可视化选择已启动');
                // 开始监听元素选择事件
                startListeningForSelection();
            } else {
                alert('启动可视化选择失败: ' + data.error);
                stopVisualSelection();
            }
        })
        .catch(error => {
            console.error('启动可视化选择时出错:', error);
            alert('启动可视化选择时发生错误: ' + error.message);
            stopVisualSelection();
        });
    }
    
    function stopVisualSelection() {
        isSelecting = false;
        
        // 更新UI状态，只在元素存在时操作
        const startSelectBtn = document.getElementById('startSelectBtn');
        const stopSelectBtn = document.getElementById('stopSelectBtn');
        const selectionStatus = document.getElementById('selectionStatus');
        
        if (startSelectBtn) {
            startSelectBtn.style.display = 'block';
        }
        if (stopSelectBtn) {
            stopSelectBtn.style.display = 'none';
        }
        if (selectionStatus) {
            selectionStatus.style.display = 'none';
        }
        
        // 调用后端API停止可视化选择
        fetch('/api/stop_visual_selection', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('可视化选择已停止');
                // 停止监听元素选择事件
                stopListeningForSelection();
            }
        })
        .catch(error => {
            console.error('停止可视化选择时出错:', error);
        });
    }
    
    function startListeningForSelection() {
        // 启动轮询，检查是否有元素被选择
        const pollInterval = setInterval(() => {
            if (!isSelecting) {
                clearInterval(pollInterval);
                return;
            }
            
            fetch('/api/check_selected_element')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.selected_element) {
                    // 元素已被选择，填充到表单
                    fillElementToForm(data.selected_element);
                    stopVisualSelection();
                    clearInterval(pollInterval);
                }
            })
            .catch(error => {
                console.error('检查选择元素时出错:', error);
            });
        }, 1000); // 每秒轮询一次
    }
    
    function stopListeningForSelection() {
        // 停止轮询
    }
    
    function fillElementToForm(elementInfo) {
        // 填充元素信息到表单，只在元素存在时操作
        const elementsToFill = [
            { id: 'stepLocatorMethod', value: elementInfo.selector_type || 'css' },
            { id: 'stepElementName', value: elementInfo.selector_value || '' }
        ];
        
        if (elementInfo.page_name) {
            elementsToFill.push({ id: 'stepPageName', value: elementInfo.page_name });
        }
        
        if (elementInfo.text_content) {
            elementsToFill.push({ id: 'stepInputValue', value: elementInfo.text_content });
        }
        
        elementsToFill.forEach(elementInfo => {
            const element = document.getElementById(elementInfo.id);
            if (element) {
                element.value = elementInfo.value;
            }
        });
        
        console.log('元素信息已填充到表单:', elementInfo);
        showCustomAlert('元素选择成功，已自动填充到表单！');
    }
    
    // 自定义模态对话框功能
    function showCustomAlert(message) {
        // 检查是否已存在模态对话框，如果不存在则创建
        let modal = document.getElementById('customAlertModal');
        if (!modal) {
            // 创建模态对话框HTML结构
            const modalHTML = `
                <div id="customAlertModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full text-center">
                        <div class="mb-4 text-gray-700">${message}</div>
                        <button id="customAlertClose" class="btn btn-primary">
                            确定
                        </button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            modal = document.getElementById('customAlertModal');
            
            // 添加关闭按钮事件
            document.getElementById('customAlertClose').addEventListener('click', function() {
                modal.classList.add('hidden');
                setTimeout(() => {
                    modal.remove();
                }, 300);
            });
            
            // 添加点击背景关闭事件
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.classList.add('hidden');
                    setTimeout(() => {
                        modal.remove();
                    }, 300);
                }
            });
        } else {
            // 更新现有模态对话框的消息
            modal.querySelector('div').textContent = message;
            modal.classList.remove('hidden');
        }
    }
    
    // 监听定位方法选择变化，自动生成XPath框架
    function generateXPathFramework(locatorType, elementNameInput) {
        if (locatorType === 'xpath' && !elementNameInput.value) {
            // 生成Playwright标准的XPath选择器框架
            const xpathFramework = 'xpath=//';
            elementNameInput.value = xpathFramework;
        }
    }
    
    function saveStep() {
        const action = document.getElementById('stepAction')?.value || '';
        const pageName = document.getElementById('stepPageName')?.value || '';
        const locatorMethod = document.getElementById('stepLocatorMethod')?.value || 'css';
        const elementName = document.getElementById('stepElementName')?.value || '';
        const inputValue = document.getElementById('stepInputValue')?.value || '';
        const swipeX = document.getElementById('stepSwipeX')?.value || '';
        const swipeY = document.getElementById('stepSwipeY')?.value || '';
        const url = document.getElementById('stepUrl')?.value || '';
        const description = document.getElementById('stepDescription')?.value || '';

        if (!action) {
            alert('请选择操作方式');
            return;
        }

        // 添加点击/输入/提取文本操作时元素定位值的必填验证
        if ((action === 'click' || action === 'input' || action === 'extract_text') && !elementName) {
            alert('点击、输入或提取文本操作必须填写元素定位值');
            return;
        }

        // 输入操作时输入值的验证
        if (action === 'input' && !inputValue) {
            alert('输入操作必须填写输入值');
            return;
        }

        // 提取文本操作时预期结果的验证
        if (action === 'extract_text' && !inputValue) {
            alert('提取文本操作必须填写预期的文本结果');
            return;
        }

        // 滑动操作时坐标的验证
        if (action === 'swipe') {
            if (!swipeX || !swipeY) {
                alert('滑动操作必须填写X轴和Y轴偏移量');
                return;
            }
        }

        // 导航操作时URL的验证
        if (action === 'navigate' && !url) {
            alert('导航操作必须填写URL地址');
            return;
        }

        const step = {
            action: action,
            page_name: pageName,
            locator_method: locatorMethod,
            element_name: elementName,
            input_value: inputValue,
            swipe_x: swipeX,
            swipe_y: swipeY,
            url: url,
            description: description
        };

        if (editingStepIndex >= 0) {
            steps[editingStepIndex] = step;
            editingStepIndex = -1;
        } else {
            steps.push(step);
        }

        renderSteps();
        hideStepForm();
    }

    function renderSteps() {
        const tbody = document.getElementById('stepsTableBody');
        if (tbody) {
            tbody.innerHTML = '';

            steps.forEach((step, index) => {
                const row = document.createElement('tr');
                row.className = 'step-row';
                
                let displayValue = '-';
                if (step.action === 'input') {
                    displayValue = step.input_value || '-';
                } else if (step.action === 'swipe') {
                    displayValue = `X: ${step.swipe_x || '0'}, Y: ${step.swipe_y || '0'}`;
                } else if (step.action === 'navigate') {
                    displayValue = step.url || '-';
                } else if (step.action === 'extract_text') {
                    displayValue = step.input_value || '-';
                }
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${step.action}</td>
                    <td>${step.page_name || '-'}</td>
                    <td>${step.locator_method || '-'}</td>
                    <td>${step.element_name || '-'}</td>
                    <td>${displayValue}</td>
                    <td>${step.description || '-'}</td>
                    <td>
                        <div class="action-buttons">
                            <button type="button" class="btn btn-sm btn-primary" onclick="editStep(${index})">编辑</button>
                            <button type="button" class="btn btn-sm btn-danger" onclick="deleteStep(${index})">删除</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
    }
    function formatDateTime(dateTimeStr) {
        const date = new Date(dateTimeStr);
        return date.toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
    }

    function editStep(index) {
        const step = steps[index];
        
        const elementsToFill = [
            { id: 'stepAction', value: step.action },
            { id: 'stepPageName', value: step.page_name || '' },
            { id: 'stepLocatorMethod', value: step.locator_method || 'css' },
            { id: 'stepElementName', value: step.element_name || '' },
            { id: 'stepInputValue', value: step.input_value || '' },
            { id: 'stepSwipeX', value: step.swipe_x || '' },
            { id: 'stepSwipeY', value: step.swipe_y || '' },
            { id: 'stepUrl', value: step.url || '' },
            { id: 'stepDescription', value: step.description || '' }
        ];
        
        elementsToFill.forEach(function(elementInfo) {
            const element = document.getElementById(elementInfo.id);
            if (element) {
                element.value = elementInfo.value;
            }
        });
        
        updateStepFormFields();
        editingStepIndex = index;
        
        const stepForm = document.getElementById('stepForm');
        if (stepForm) {
            stepForm.classList.add('active');
        }
    }

    function deleteStep(index) {
        if (confirm('确定要删除这个步骤吗？')) {
            steps.splice(index, 1);
            renderSteps();
        }
    }

    // 模态框相关函数
    window.openTitleModal = function() {
        console.log('openTitleModal函数被调用');
        const modalCaseTitle = document.getElementById('modalCaseTitle');
        const modalCaseDescription = document.getElementById('modalCaseDescription');
        const titleModal = document.getElementById('titleModal');
        
        console.log('模态框元素检查:', {
            modalCaseTitle: modalCaseTitle ? '找到' : '未找到',
            modalCaseDescription: modalCaseDescription ? '找到' : '未找到',
            titleModal: titleModal ? '找到' : '未找到'
        });
        
        if (modalCaseTitle && modalCaseDescription && titleModal) {
            modalCaseTitle.value = caseTitle;
            modalCaseDescription.value = caseDescription;
            titleModal.classList.remove('hidden');
            console.log('模态框已显示');
        } else {
            console.error('模态框元素未找到');
            alert('模态框元素未找到，请检查页面结构');
        }
    }

    window.closeTitleModal = function() {
        const titleModal = document.getElementById('titleModal');
        if (titleModal) {
            titleModal.classList.add('hidden');
        }
    }

    // 标题表单提交
    document.addEventListener('DOMContentLoaded', function() {
        // 处理标题表单提交
        if (document.getElementById('titleForm')) {
            document.getElementById('titleForm').addEventListener('submit', function(e) {
                e.preventDefault();
                caseTitle = document.getElementById('modalCaseTitle').value;
                caseDescription = document.getElementById('modalCaseDescription').value;
                
                document.getElementById('currentCaseTitle').textContent = caseTitle || '未设置标题';
                document.getElementById('currentCaseDescription').textContent = caseDescription || '未设置描述';
                
                closeTitleModal();
            });
        }
        
        // 监听定位方法选择变化，自动生成XPath框架
        const locatorMethodSelect = document.getElementById('stepLocatorMethod');
        const elementNameInput = document.getElementById('stepElementName');
        
        if (locatorMethodSelect && elementNameInput) {
            // 定位方法变化事件
            locatorMethodSelect.addEventListener('change', function() {
                generateXPathFramework(this.value, elementNameInput);
            });
            
            // 元素定位值输入框清空事件
            elementNameInput.addEventListener('input', function() {
                if (locatorMethodSelect.value === 'xpath' && !this.value) {
                    generateXPathFramework('xpath', this);
                }
            });
            
            // 聚焦事件，确保光标位置正确
            elementNameInput.addEventListener('focus', function() {
                if (locatorMethodSelect.value === 'xpath' && this.value === 'xpath=//') {
                    // 将光标定位到XPath框架的适当位置
                    this.setSelectionRange(7, 7);
                }
            });
        }
        console.log('DOM加载完成，开始初始化页面...');
        
        document.getElementById('caseForm').addEventListener('submit', async function(e) {
            e.preventDefault();
        
            console.log('=== 开始提交表单 ===');
        
            const projectId = document.getElementById('projectSelect').value;
        
            console.log('表单数据:', {
                projectId: projectId,
                caseTitle: caseTitle,
                caseDescription: caseDescription,
                stepsCount: steps.length
            });
        
            if (!projectId) {
                alert('请选择项目');
                return;
            }
        
            if (!caseTitle) {
                alert('请输入用例标题');
                return;
            }
        
            try {
                console.log('发送创建/更新用例请求...');
                        
                let response, data;
                if (currentCaseId) {
                    // 更新用例
                    response = await fetch(`/api/cases/${currentCaseId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            name: caseTitle,
                            url: '',
                            description: caseDescription,
                            precondition: '',
                            expected_result: ''
                        })
                    });
                    data = await response.json();
                            
                    if (data.success) {
                        // 删除原有步骤
                        await fetch(`/api/cases/${currentCaseId}/steps`, {
                            method: 'DELETE'
                        });
                                
                        // 添加新步骤
                        for (let i = 0; i < steps.length; i++) {
                            const step = steps[i];
                            let stepData = {
                                case_id: currentCaseId,
                                action: step.action,
                                selector_type: step.locator_method,
                                selector_value: step.element_name || '',
                                description: step.description || '',
                                step_order: i + 1,
                                page_name: step.page_name || ''
                            };
                                    
                            if (step.action === 'input') {
                                stepData.input_value = step.input_value || '';
                            } else if (step.action === 'swipe') {
                                stepData.swipe_x = step.swipe_x || '0';
                                stepData.swipe_y = step.swipe_y || '0';
                            } else if (step.action === 'navigate') {
                                stepData.url = step.url || '';
                            } else if (step.action === 'extract_text') {
                                stepData.input_value = step.input_value || '';
                            }
                                    
                            await fetch('/api/steps', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(stepData)
                            });
                        }
        
                        alert('测试用例更新成功！');
                        window.location.href = '/list_projects';
                    } else {
                        alert('更新失败: ' + (data.error || '未知错误'));
                    }
                } else {
                    // 创建用例
                    response = await fetch('/api/cases', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            project_id: parseInt(projectId),
                            name: caseTitle,
                            url: '',
                            description: caseDescription,
                            precondition: '',
                            expected_result: ''
                        })
                    });
        
                    console.log('响应状态:', response.status);
                    data = await response.json();
                    console.log('响应数据:', data);
        
                    if (data.success) {
                        const caseId = data.case_id;
                                
                        for (let i = 0; i < steps.length; i++) {
                            const step = steps[i];
                            let stepData = {
                                case_id: caseId,
                                action: step.action,
                                selector_type: step.locator_method,
                                selector_value: step.element_name || '',
                                description: step.description || '',
                                step_order: i + 1,
                                page_name: step.page_name || ''
                            };
                                    
                            if (step.action === 'input') {
                                stepData.input_value = step.input_value || '';
                            } else if (step.action === 'swipe') {
                                stepData.swipe_x = step.swipe_x || '0';
                                stepData.swipe_y = step.swipe_y || '0';
                            } else if (step.action === 'navigate') {
                                stepData.url = step.url || '';
                            }
                                    
                            await fetch('/api/steps', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(stepData)
                            });
                        }
        
                        alert('测试用例创建成功！用例ID: ' + caseId);
                        window.location.href = '/list_projects';
                    } else {
                        alert('创建失败: ' + (data.error || '未知错误'));
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                alert('创建测试用例时发生错误: ' + error.message);
            }
        });

        // 加载项目数据
        async function refreshProjects() {
            console.log('调用loadProjects函数...');
            try {
                await loadProjects();
                console.log('项目数据加载完成');
            } catch (error) {
                console.error('项目数据加载失败:', error);
            }
        }
        
        // 页面加载时调用，确保异步操作被正确处理
        (async () => {
            await refreshProjects();
        })();
        
        // 添加项目列表刷新按钮点击事件（如果存在）
        const refreshBtn = document.getElementById('refreshProjectsBtn');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', refreshProjects);
        }
        
        // 处理URL参数
        console.log('处理URL参数...');
        const urlParams = new URLSearchParams(window.location.search);
        const projectId = urlParams.get('project_id');
        if (projectId) {
            console.log('URL中包含project_id参数:', projectId);
            setTimeout(() => {
                document.getElementById('projectSelect').value = projectId;
                console.log('已设置项目选择器值为:', projectId);
            }, 500);
        }
        
        // 检查是否有case_id参数，如果有则加载测试用例
        const caseId = urlParams.get('case_id');
        if (caseId) {
            console.log('URL中包含case_id参数:', caseId);
            loadTestCase(caseId);
        }
        
        // 为模态框关闭按钮添加事件监听器
        const closeModalBtn = document.getElementById('closeModalBtn');
        const cancelModalBtn = document.getElementById('cancelModalBtn');
        
        if (closeModalBtn) {
            closeModalBtn.addEventListener('click', closeTitleModal);
        }
        
        if (cancelModalBtn) {
            cancelModalBtn.addEventListener('click', closeTitleModal);
        }
        
        console.log('页面初始化完成');
    });
</script>
    <!-- 标题和描述编辑模态框 -->
    <div id="titleModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">编辑用例标题和描述</h3>
                <button type="button" class="text-gray-400" id="closeModalBtn">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <form id="titleForm">
                <div class="form-group mb-4">
                    <label for="modalCaseTitle" class="block text-sm font-medium text-gray-700 mb-1">用例标题 *</label>
                    <input type="text" id="modalCaseTitle" required placeholder="请输入用例标题" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                <div class="form-group mb-4">
                    <label for="modalCaseDescription" class="block text-sm font-medium text-gray-700 mb-1">用例描述</label>
                    <textarea id="modalCaseDescription" placeholder="请输入测试用例的详细描述..." rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"></textarea>
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" class="btn btn-outline" id="cancelModalBtn">取消</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>
</body>
</html>