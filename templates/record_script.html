<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>录制测试脚本 - UI自动化测试平台</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .control-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        .btn {
            display: inline-block;
            padding: 10px 20px;
            background: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            margin: 5px;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn-success {
            background: #28a745;
        }
        .btn-success:hover {
            background: #218838;
        }
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        .btn-warning:hover {
            background: #e0a800;
        }
        .btn-danger {
            background: #dc3545;
        }
        .btn-danger:hover {
            background: #c82333;
        }
        .btn-secondary {
            background: #6c757d;
        }
        .btn-secondary:hover {
            background: #545b62;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input[type="text"], input[type="url"], select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
        }
        .status {
            padding: 12px 15px;
            border-radius: 4px;
            margin: 15px 0;
            text-align: center;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status.recording {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            animation: pulse 2s infinite;
        }
        .status.ready {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .steps-container {
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            background: #f9f9f9;
        }
        .step-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            font-family: monospace;
        }
        .step-item:last-child {
            border-bottom: none;
        }
        .step-action {
            font-weight: bold;
            color: #007bff;
        }
        .step-details {
            color: #666;
            font-size: 0.9em;
        }
        .navigation {
            text-align: center;
            margin-top: 30px;
        }
        .hidden {
            display: none;
        }
        .additional-controls {
            margin-top: 15px;
            text-align: center;
        }
        .additional-controls .form-group {
            display: inline-block;
            margin: 0 10px;
            width: 200px;
        }
        .recording-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #dc3545;
            margin-right: 8px;
            animation: blink 1.5s infinite;
        }
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(220, 53, 69, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(220, 53, 69, 0);
            }
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        .progress-bar {
            height: 5px;
            width: 100%;
            background-color: #f1f1f1;
            border-radius: 5px;
            margin: 10px 0;
            overflow: hidden;
        }
        .progress {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #0056b3);
            width: 0%;
            transition: width 0.3s ease;
        }
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: white;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            transform: translateX(120%);
            transition: transform 0.3s ease;
            max-width: 300px;
        }
        .toast.show {
            transform: translateX(0);
        }
        .toast.success {
            border-left: 4px solid #28a745;
        }
        .toast.error {
            border-left: 4px solid #dc3545;
        }
        .toast.info {
            border-left: 4px solid #17a2b8;
        }
        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0,0,0,.1);
            border-radius: 50%;
            border-top-color: #007bff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
            vertical-align: middle;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .btn:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
        .step-counter {
            display: inline-block;
            background: #007bff;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <!-- Toast通知容器 -->
    <div id="toastContainer"></div>
    
    <div class="container">
        <h1>录制测试脚本</h1>
        
        <div class="control-panel">
            <div class="form-group">
                <label for="targetUrl">目标URL</label>
                <input type="url" id="targetUrl" placeholder="https://example.com" value="">
            </div>
            
            <div style="text-align: center;">
                <button id="startRecordingBtn" class="btn btn-success">开始录制</button>
                <button id="stopRecordingBtn" class="btn btn-danger hidden">停止录制</button>
                <button id="navigateBtn" class="btn">导航到URL</button>
                <a href="/" class="btn btn-secondary">返回首页</a>
            </div>
            
            <div id="statusMessage" class="status hidden">
                准备就绪
            </div>
            
            <div id="progressBar" class="progress-bar hidden">
                <div id="progress" class="progress"></div>
            </div>
            
            <div id="advancedControls" class="additional-controls hidden">
                <!-- 自动录制功能已启用，已移除所有手动操作按钮 -->
            </div>
            
            <div id="stepsContainer" class="steps-container hidden">
                <div class="step-item">
                    <span class="step-action">导航</span>
                    <span class="step-details">到 https://www.baidu.com</span>
                </div>
            </div>
        </div>
        
        <div class="navigation">
            <div style="text-align: center; margin-top: 30px;">
                <span>上一步:</span>
                <a href="/create_case" class="btn btn-primary">创建测试用例</a>
                <span style="margin: 0 10px;">|</span>
                <span>下一步:</span>
                <a href="/playback_script" class="btn btn-primary">执行脚本</a>
            </div>
        </div>
    </div>
    
    <script>
        // 等待DOM完全加载后再执行JavaScript代码
        document.addEventListener('DOMContentLoaded', function() {
        let isRecording = false;
        let recordedSteps = [];
        
        // Toast通知函数
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            let icon = '';
            if (type === 'success') {
                icon = '✓';
            } else if (type === 'error') {
                icon = '✗';
            } else if (type === 'info') {
                icon = 'ℹ';
            }
            
            toast.innerHTML = `<span style="margin-right:10px;font-weight:bold;">${icon}</span>${message}`;
            toastContainer.appendChild(toast);
            
            // 触发显示动画
            setTimeout(() => toast.classList.add('show'), 10);
            
            // 3秒后移除
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        // 显示/隐藏进度条
        function showProgress(show = true) {
            const progressBar = document.getElementById('progressBar');
            if (show) {
                progressBar.classList.remove('hidden');
                // 模拟进度条动画
                let progress = 0;
                const interval = setInterval(() => {
                    progress += 5;
                    document.getElementById('progress').style.width = `${progress}%`;
                    if (progress >= 90) {
                        clearInterval(interval);
                    }
                }, 100);
            } else {
                progressBar.classList.add('hidden');
                document.getElementById('progress').style.width = '0%';
            }
        }
        
        // 更新状态信息
        function updateStatus(message, type = 'ready') {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            statusEl.classList.remove('hidden');
            
            // 如果是录制状态，添加录制指示器
            if (type === 'recording') {
                const indicator = document.createElement('span');
                indicator.className = 'recording-indicator';
                statusEl.prepend(indicator);
            }
        }
        
        document.getElementById('startRecordingBtn').addEventListener('click', async function() {
            const targetUrl = document.getElementById('targetUrl').value;
            if (!targetUrl) {
                showToast('请输入目标URL', 'error');
                return;
            }
            
            try {
                // 确保所有必要的元素都已存在
                const startRecordingBtn = document.getElementById('startRecordingBtn');
                const stopRecordingBtn = document.getElementById('stopRecordingBtn');
                const advancedControls = document.getElementById('advancedControls');
                const statusMessage = document.getElementById('statusMessage');
                const stepsContainer = document.getElementById('stepsContainer');
                
                if (!startRecordingBtn || !stopRecordingBtn || !advancedControls || !statusMessage || !stepsContainer) {
                    showToast('界面元素未完全加载，请刷新页面后重试', 'error');
                    return;
                }
                
                // 禁用开始按钮，显示进度条
                startRecordingBtn.disabled = true;
                showProgress(true);
                updateStatus('正在启动浏览器...', 'info');
                
                // 启动录制
                const response = await fetch('/api/start_recording', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        url: targetUrl
                    })
                });
                
                const data = await response.json();
                
                // 隐藏进度条
                showProgress(false);
                
                if (data.success) {
                    isRecording = true;
                    recordedSteps = [];
                    
                    document.getElementById('startRecordingBtn').classList.add('hidden');
                    document.getElementById('stopRecordingBtn').classList.remove('hidden');
                    document.getElementById('advancedControls').classList.remove('hidden');
                    
                    updateStatus('正在录制中...请在浏览器中进行操作', 'recording');
                    document.getElementById('stepsContainer').classList.remove('hidden');
                    
                    showToast('录制已开始，请在打开的浏览器中进行操作', 'success');
                } else {
                    updateStatus('录制启动失败', 'error');
                    showToast(`启动录制失败: ${data.error}`, 'error');
                    startRecordingBtn.disabled = false;
                }
            } catch (error) {
                showProgress(false);
                updateStatus('录制启动失败', 'error');
                showToast(`启动录制时发生错误: ${error.message}`, 'error');
                document.getElementById('startRecordingBtn').disabled = false;
            }
        });
        
        document.getElementById('stopRecordingBtn').addEventListener('click', async function() {
            try {
                // 禁用停止按钮，显示进度条
                this.disabled = true;
                showProgress(true);
                updateStatus('正在停止录制并获取数据...', 'info');
                
                // 停止录制
                const response = await fetch('/api/stop_recording', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                // 完成进度条
                document.getElementById('progress').style.width = '100%';
                
                setTimeout(() => {
                    showProgress(false);
                    
                    if (data.success) {
                        isRecording = false;
                        recordedSteps = data.steps || [];
                        
                        document.getElementById('stopRecordingBtn').classList.add('hidden');
                        document.getElementById('startRecordingBtn').classList.remove('hidden');
                        document.getElementById('advancedControls').classList.add('hidden');
                        
                        updateStatus(`录制完成，共记录 ${recordedSteps.length} 个步骤`, 'ready');
                        
                        if (data.warning) {
                            showToast(data.warning, 'info');
                        }
                        
                        renderSteps(recordedSteps);
                        
                        // 询问是否保存录制的脚本
                        if (recordedSteps.length > 0) {
                            if (confirm('录制完成，是否保存脚本？')) {
                                saveScript();
                            }
                        } else {
                            showToast('录制完成但没有记录到任何操作步骤', 'info');
                        }
                        
                        showToast('录制成功停止', 'success');
                    } else {
                        updateStatus('录制停止失败', 'error');
                        showToast(`停止录制失败: ${data.error}`, 'error');
                        this.disabled = false;
                    }
                }, 500);
            } catch (error) {
                showProgress(false);
                updateStatus('录制停止失败', 'error');
                showToast(`停止录制时发生错误: ${error.message}`, 'error');
                this.disabled = false;
            }
        });
        
        document.getElementById('navigateBtn').addEventListener('click', async function() {
            const targetUrl = document.getElementById('targetUrl').value;
            if (!targetUrl) {
                showToast('请输入目标URL', 'error');
                return;
            }
            
            // 禁用按钮，显示进度
            this.disabled = true;
            const originalText = this.innerHTML;
            this.innerHTML = '<span class="loader"></span>导航中...';
            
            await navigateToUrl(targetUrl);
            
            // 恢复按钮
            this.disabled = false;
            this.innerHTML = originalText;
        });
        
        // 移除手动滚动功能，仅保留录制和回放时的滚动操作
        // 手动滚动功能已移除，滚动操作将在录制和回放过程中自动处理
        
        // 点击事件
        document.getElementById('clickBtn').addEventListener('click', async function() {
            const selector = prompt('请输入元素选择器:');
            if (!selector) {
                alert('请输入元素选择器');
                return;
            }
            
            try {
                const response = await fetch('/api/click_element', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        selector: selector
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('点击操作执行成功');
                    
                    // 如果正在录制，记录步骤
                    if (isRecording) {
                        const step = {
                            action: 'click',
                            selector: selector,
                            timestamp: Date.now()
                        };
                        recordedSteps.push(step);
                        renderSteps(recordedSteps);
                    }
                } else {
                    alert('点击操作失败: ' + data.error);
                }
            } catch (error) {
                alert('执行点击时发生错误: ' + error.message);
            }
        });
        
        // 填充事件
        document.getElementById('fillBtn').addEventListener('click', async function() {
            const selector = prompt('请输入元素选择器:');
            if (!selector) {
                alert('请输入元素选择器');
                return;
            }
            
            const text = prompt('请输入填充文本:');
            if (text === null) {
                return;
            }
            
            try {
                const response = await fetch('/api/fill_input', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        selector: selector,
                        text: text
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('填充操作执行成功');
                    
                    // 如果正在录制，记录步骤
                    if (isRecording) {
                        const step = {
                            action: 'fill',
                            selector: selector,
                            text: text,
                            timestamp: Date.now()
                        };
                        recordedSteps.push(step);
                        renderSteps(recordedSteps);
                    }
                } else {
                    alert('填充操作失败: ' + data.error);
                }
            } catch (error) {
                alert('执行填充时发生错误: ' + error.message);
            }
        });
        
        // 悬停事件
        document.getElementById('hoverBtn').addEventListener('click', async function() {
            const selector = prompt('请输入元素选择器:');
            if (!selector) {
                alert('请输入元素选择器');
                return;
            }
            
            try {
                const response = await fetch('/api/hover_element', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        selector: selector
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('悬停操作执行成功');
                } else {
                    alert('悬停操作失败: ' + data.error);
                }
            } catch (error) {
                alert('执行悬停时发生错误: ' + error.message);
            }
        });
        
        // 双击事件
        document.getElementById('doubleClickBtn').addEventListener('click', async function() {
            const selector = prompt('请输入元素选择器:');
            if (!selector) {
                alert('请输入元素选择器');
                return;
            }
            
            try {
                const response = await fetch('/api/double_click', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        selector: selector
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('双击操作执行成功');
                    
                    // 如果正在录制，记录步骤
                    if (isRecording) {
                        const step = {
                            action: 'double_click',
                            selector: selector,
                            timestamp: Date.now()
                        };
                        recordedSteps.push(step);
                        renderSteps(recordedSteps);
                    }
                } else {
                    alert('双击操作失败: ' + data.error);
                }
            } catch (error) {
                alert('执行双击时发生错误: ' + error.message);
            }
        });
        
        // 右键点击事件
        document.getElementById('rightClickBtn').addEventListener('click', async function() {
            const selector = prompt('请输入元素选择器:');
            if (!selector) {
                alert('请输入元素选择器');
                return;
            }
            
            try {
                const response = await fetch('/api/right_click', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        selector: selector
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('右键点击操作执行成功');
                    
                    // 如果正在录制，记录步骤
                    if (isRecording) {
                        const step = {
                            action: 'right_click',
                            selector: selector,
                            timestamp: Date.now()
                        };
                        recordedSteps.push(step);
                        renderSteps(recordedSteps);
                    }
                } else {
                    alert('右键点击操作失败: ' + data.error);
                }
            } catch (error) {
                alert('执行右键点击时发生错误: ' + error.message);
            }
        });
        
        // 提取文本事件
        document.getElementById('extractTextBtn').addEventListener('click', async function() {
            const selector = document.getElementById('elementSelector').value;
            const targetSelector = selector || 'body';
            
            try {
                const response = await fetch('/api/extract_text', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        selector: targetSelector
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('提取的文本内容:\n\n' + data.text.substring(0, 500) + (data.text.length > 500 ? '...' : ''));
                    console.log('完整文本内容:', data.text);
                } else {
                    alert('提取文本失败: ' + data.error);
                }
            } catch (error) {
                alert('提取文本时发生错误: ' + error.message);
            }
        });
        
        // 提取元素数据事件
        document.getElementById('extractDataBtn').addEventListener('click', async function() {
            const selector = document.getElementById('elementSelector').value;
            if (!selector) {
                alert('请输入元素选择器');
                return;
            }
            
            try {
                const response = await fetch('/api/extract_element_data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        selector: selector
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('提取的元素数据:', data.data);
                    alert('元素数据已提取到控制台，请查看F12控制台');
                } else {
                    alert('提取元素数据失败: ' + data.error);
                }
            } catch (error) {
                alert('提取元素数据时发生错误: ' + error.message);
            }
        });
        
        // 分析页面内容事件
        document.getElementById('analyzeContentBtn').addEventListener('click', async function() {
            const selector = document.getElementById('elementSelector').value;
            const targetSelector = selector || 'body';
            
            try {
                const response = await fetch('/api/analyze_content', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        selector: targetSelector
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('页面内容分析:', data.analysis);
                    alert('分析结果:\n' + data.analysis.summary + '\n\n详细信息已输出到控制台');
                } else {
                    alert('分析页面内容失败: ' + data.error);
                }
            } catch (error) {
                alert('分析页面内容时发生错误: ' + error.message);
            }
        });
        
        // 等待元素出现事件
        document.getElementById('waitForSelectorBtn').addEventListener('click', async function() {
            const selector = document.getElementById('elementSelector').value;
            if (!selector) {
                alert('请输入元素选择器');
                return;
            }
            
            const timeout = prompt('请输入超时时间(毫秒):', '30000');
            if (!timeout) return;
            
            try {
                const response = await fetch('/api/wait_for_selector', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        selector: selector,
                        timeout: parseInt(timeout)
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('等待元素出现操作执行成功');
                    
                    // 如果正在录制，记录步骤
                    if (isRecording) {
                        const step = {
                            action: 'wait_for_selector',
                            selector: selector,
                            timeout: parseInt(timeout),
                            timestamp: Date.now()
                        };
                        recordedSteps.push(step);
                        renderSteps(recordedSteps);
                    }
                } else {
                    alert('等待元素出现操作失败: ' + data.error);
                }
            } catch (error) {
                alert('执行等待元素出现时发生错误: ' + error.message);
            }
        });
        
        // 移除所有与元素选择器相关的功能
        // 包括显示/隐藏元素选择器弹窗、加载页面元素、显示元素列表、搜索元素等功能
        
        // 等待元素可见事件
        document.getElementById('waitForVisibleBtn').addEventListener('click', async function() {
            const selector = document.getElementById('elementSelector').value;
            if (!selector) {
                alert('请输入元素选择器');
                return;
            }
            
            const timeout = prompt('请输入超时时间(毫秒):', '30000');
            if (!timeout) return;
            
            try {
                const response = await fetch('/api/wait_for_element_visible', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        selector: selector,
                        timeout: parseInt(timeout)
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('等待元素可见操作执行成功');
                    
                    // 如果正在录制，记录步骤
                    if (isRecording) {
                        const step = {
                            action: 'wait_for_element_visible',
                            selector: selector,
                            timeout: parseInt(timeout),
                            timestamp: Date.now()
                        };
                        recordedSteps.push(step);
                        renderSteps(recordedSteps);
                    }
                } else {
                    alert('等待元素可见操作失败: ' + data.error);
                }
            } catch (error) {
                alert('执行等待元素可见时发生错误: ' + error.message);
            }
        });
        
        // 等待固定时间事件
        document.getElementById('waitBtn').addEventListener('click', async function() {
            const waitTime = prompt('请输入等待时间(毫秒):', '1000');
            if (!waitTime) return;
            
            try {
                // 简单的等待操作，不需调用API
                console.log('等待操作执行成功');
                
                // 如果正在录制，记录步骤
                if (isRecording) {
                    const step = {
                        action: 'wait',
                        time: parseInt(waitTime),
                        timestamp: Date.now()
                    };
                    recordedSteps.push(step);
                    renderSteps(recordedSteps);
                }
            } catch (error) {
                alert('执行等待时发生错误: ' + error.message);
            }
        });
        
        // 截图事件
        document.getElementById('screenshotBtn').addEventListener('click', async function() {
            try {
                // 创建一个新的窗口来显示截图
                const response = await fetch('/api/screenshot');
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                
                // 创建一个新窗口显示截图
                const screenshotWindow = window.open('', '_blank');
                screenshotWindow.document.write(`<html><head><title>页面截图</title></head><body style="margin:0;padding:20px;"><h3>页面截图</h3><img src="${url}" style="max-width:100%; height:auto;" onload="window.focus();" onerror="console.error('图片加载失败:', this.src);" /></body></html>`);
                
                // 如果正在录制，记录步骤
                if (isRecording) {
                    const step = {
                        action: 'screenshot',
                        timestamp: Date.now()
                    };
                    recordedSteps.push(step);
                    renderSteps(recordedSteps);
                }
            } catch (error) {
                alert('截图时发生错误: ' + error.message);
            }
        });
        
        // 关闭弹窗事件
        document.getElementById('closeModal').addEventListener('click', hideElementSelector);
        
        // 点击弹窗外部关闭
        document.getElementById('elementSelectorModal').addEventListener('click', function(e) {
            if (e.target === this) {
                hideElementSelector();
            }
        });
        
        // 搜索元素事件
        document.getElementById('searchElements').addEventListener('input', searchElements);
        
        // 打开元素选择器按钮事件
        document.getElementById('openSelectorBtn').addEventListener('click', function() {
            showElementSelector();
        });
        
        async function navigateToUrl(url) {
            try {
                const response = await fetch('/api/navigate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        url: url
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('导航成功', 'success');
                    
                    // 如果正在录制，记录导航步骤
                    if (isRecording) {
                        const step = {
                            action: 'navigate',
                            url: url,
                            timestamp: Date.now()
                        };
                        recordedSteps.push(step);
                        renderSteps(recordedSteps);
                    }
                } else {
                    showToast(`导航失败: ${data.error}`, 'error');
                }
            } catch (error) {
                showToast(`导航时发生错误: ${error.message}`, 'error');
            }
        }
        
        function renderSteps(steps) {
            const stepsList = document.getElementById('stepsContainer');
            stepsList.innerHTML = '';
            
            steps.forEach((step, index) => {
                const stepEl = document.createElement('div');
                stepEl.className = 'step-item';
                
                let stepDesc = '';
                switch(step.action) {
                    case 'navigate':
                        stepDesc = `导航到: ${step.url}`;
                        break;
                    case 'click':
                        stepDesc = `点击元素: ${step.selector}`;
                        break;
                    case 'fill':
                        stepDesc = `填充输入框 "${step.selector}" 为 "${step.text}"`;
                        break;
                    case 'scroll':
                        // 处理新的滚动格式
                        if (step.scrollDirection) {
                            const directionText = step.scrollDirection.y === 'down' ? '向下' : 
                                                 step.scrollDirection.y === 'up' ? '向上' : 
                                                 step.scrollDirection.x === 'right' ? '向右' : 
                                                 step.scrollDirection.x === 'left' ? '向左' : '';
                            const distance = step.scrollDistance.y || step.scrollDistance.x || 0;
                            stepDesc = `滚动页面 ${directionText} ${distance}px`;
                        } else {
                            // 兼容旧格式
                            stepDesc = `滚动页面 ${step.direction}`;
                            if (step.direction === 'down' || step.direction === 'up') {
                                stepDesc += ` ${step.pixels}px`;
                            }
                        }
                        break;
                    case 'hover':
                        stepDesc = `悬停在元素: ${step.selector}`;
                        break;
                    case 'double_click':
                        stepDesc = `双击元素: ${step.selector}`;
                        break;
                    case 'right_click':
                        stepDesc = `右键点击元素: ${step.selector}`;
                        break;
                    case 'wait':
                        stepDesc = `等待 ${step.time} 毫秒`;
                        break;
                    case 'wait_for_selector':
                        stepDesc = `等待元素出现: ${step.selector} (超时: ${step.timeout}ms)`;
                        break;
                    case 'wait_for_element_visible':
                        stepDesc = `等待元素可见: ${step.selector} (超时: ${step.timeout}ms)`;
                        break;
                    case 'screenshot':
                        stepDesc = `获取页面截图`;
                        break;
                    default:
                        stepDesc = `${step.action}: ${JSON.stringify(step)}`;
                }
                
                stepEl.innerHTML = `
                    <span class="step-index">${index + 1}.</span>
                    <span class="step-action">${step.action}</span>
                    <span class="step-details">${stepDesc}</span>
                `;
                
                stepsList.appendChild(stepEl);
            });
        }
        
        async function saveScript() {
            const scriptName = prompt('请输入脚本名称:');
            if (!scriptName) {
                return;
            }
            
            // 首先让用户选择关联的测试用例
            const testCaseId = await selectTestCase();
            if (!testCaseId) {
                alert('请选择一个测试用例');
                return;
            }
            
            try {
                // 创建脚本
                const response = await fetch('/api/create_script', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        case_id: testCaseId,
                        name: scriptName
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // 更新脚本步骤
                    await updateScriptSteps(data.script_id, recordedSteps);
                    alert('脚本保存成功！');
                } else {
                    alert('创建脚本失败: ' + data.error);
                }
            } catch (error) {
                alert('保存脚本时发生错误: ' + error.message);
            }
        }
        
        // 弹出选择测试用例的函数
        async function selectTestCase() {
            // 首先检查是否从create_case页面传递了测试用例ID
            const currentTestCaseId = sessionStorage.getItem('currentTestCaseId');
            const currentTargetUrl = sessionStorage.getItem('currentTargetUrl');
            
            if (currentTestCaseId) {
                // 如果有从create_case页面传递的测试用例ID，直接使用它
                sessionStorage.removeItem('currentTestCaseId');
                sessionStorage.removeItem('currentTargetUrl');
                
                // 同时更新目标URL输入框
                if (currentTargetUrl) {
                    document.getElementById('targetUrl').value = currentTargetUrl;
                }
                
                return currentTestCaseId;
            }
            
            try {
                // 获取所有测试用例
                const response = await fetch('/api/test_cases');
                const data = await response.json();
                
                if (!data.cases || data.cases.length === 0) {
                    alert('没有找到测试用例，请先创建测试用例');
                    if (confirm('是否跳转到创建测试用例页面？')) {
                        window.location.href = '/create_case';
                    }
                    return null;
                }
                
                // 创建选择对话框
                const caseList = data.cases.map(testCase => 
                    `<option value="${testCase.id}">${testCase.name}</option>`
                ).join('');
                
                const selectHtml = `
                    <div id="testCaseModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                        <div style="background: white; padding: 20px; border-radius: 8px; width: 400px; max-width: 90%;">
                            <h3>选择测试用例</h3>
                            <select id="testCaseSelect" style="width: 100%; padding: 10px; margin: 10px 0;">
                                ${caseList}
                            </select>
                            <div style="text-align: center; margin-top: 20px;">
                                <button id="confirmCaseBtn" class="btn btn-success">确定</button>
                                <button id="cancelCaseBtn" class="btn btn-secondary">取消</button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', selectHtml);
                
                return new Promise((resolve) => {
                    document.getElementById('confirmCaseBtn').addEventListener('click', function() {
                        const selectedId = document.getElementById('testCaseSelect').value;
                        document.getElementById('testCaseModal').remove();
                        resolve(selectedId);
                    });
                    
                    document.getElementById('cancelCaseBtn').addEventListener('click', function() {
                        document.getElementById('testCaseModal').remove();
                        resolve(null);
                    });
                });
            } catch (error) {
                console.error('获取测试用例失败:', error);
                alert('获取测试用例失败: ' + error.message);
                return null;
            }
        }
        
        async function updateScriptSteps(scriptId, steps) {
            try {
                const response = await fetch(`/api/script/${scriptId}/steps`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        steps: steps
                    })
                });
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || '更新脚本步骤失败');
                }
            } catch (error) {
                alert('更新脚本步骤时发生错误: ' + error.message);
            }
        }
    });
    </script>


</body>
</html>