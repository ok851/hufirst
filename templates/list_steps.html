<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•ç”¨ä¾‹æ­¥éª¤ç®¡ç† - UIè‡ªåŠ¨åŒ–æµ‹è¯•å¹³å°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .header .case-info {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .toolbar {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .toolbar-left {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .toolbar-right {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #545b62;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .content {
            padding: 30px;
        }
        
        .steps-list {
            margin-top: 20px;
        }
        
        .step-item {
            display: flex;
            align-items: flex-start;
            padding: 15px 20px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 10px;
            background: white;
            transition: all 0.3s ease;
        }
        
        .step-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-color: #667eea;
        }
        
        .step-number {
            background: #667eea;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            margin-right: 15px;
            flex-shrink: 0;
        }
        
        .step-content {
            flex: 1;
            padding: 0 15px;
        }
        
        .step-content h4 {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .step-details {
            font-size: 13px;
            color: #666;
            line-height: 1.4;
        }
        
        .step-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }
        
        /* æ‹–åŠ¨æ’åºæ ·å¼ */
        .steps-list {
            min-height: 100px;
        }
        
        .step-item {
            cursor: grab;
            transition: all 0.3s ease;
        }
        
        .step-item:hover {
            background: rgba(102, 126, 234, 0.05);
        }
        
        .step-item:active {
            cursor: grabbing;
        }
        
        .step-item.dragging {
            opacity: 0.8;
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .step-item.over {
            border-top: 2px solid #667eea;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }
        
        .empty-state-text {
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 500px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            margin-bottom: 20px;
        }
        
        .modal-header h3 {
            color: #333;
            font-size: 22px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }
        
        .form-group textarea {
            height: 100px;
            resize: vertical;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        /* iframeå¼€å…³æ ·å¼ä¼˜åŒ– */
        .iframe-switch-container {
            margin-bottom: 16px;
        }
        .iframe-switch-container label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-weight: 500;
            color: #374151;
        }
        .iframe-switch-container input[type="checkbox"] {
            position: relative;
            width: 40px;
            height: 20px;
            appearance: none;
            background-color: #e5e7eb;
            border-radius: 10px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .iframe-switch-container input[type="checkbox"]:checked {
            background-color: #3b82f6;
        }
        .iframe-switch-container input[type="checkbox"]::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 16px;
            height: 16px;
            background-color: white;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        .iframe-switch-container input[type="checkbox"]:checked::before {
            transform: translateX(20px);
        }
        .iframe-selector-field {
            margin-top: 12px;
            padding: 16px;
            background-color: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            transition: all 0.3s ease;
        }
        .iframe-selector-field label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
            color: #4b5563;
        }
        .iframe-selector-field input {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        .iframe-selector-field input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .iframe-selector-field input::placeholder {
            color: #9ca3af;
        }
        /* éšè—ç±» */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>æµ‹è¯•ç”¨ä¾‹æ­¥éª¤ç®¡ç†</h1>
            <div class="case-info" id="caseInfo">æ­£åœ¨åŠ è½½ç”¨ä¾‹ä¿¡æ¯...</div>
        </div>
        
        <div class="toolbar">
            <div class="toolbar-left">
                <button onclick="showCreateStepModal()" class="btn btn-primary">+ æ·»åŠ æ­¥éª¤</button>
                <button onclick="runTestCase()" class="btn btn-success">â–¶ è¿è¡Œç”¨ä¾‹</button>
            </div>
            <div class="toolbar-right">
                <button onclick="backToCases()" class="btn btn-secondary">â† è¿”å›ç”¨ä¾‹åˆ—è¡¨</button>
            </div>
        </div>
        
        <div class="content">
            <div id="stepsList">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>æ­£åœ¨åŠ è½½æµ‹è¯•æ­¥éª¤...</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- æ·»åŠ æ­¥éª¤æ¨¡æ€æ¡† -->
    <div id="createStepModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>æ·»åŠ æµ‹è¯•æ­¥éª¤</h3>
            </div>
            <div class="form-group">
                <label for="stepAction">æ“ä½œç±»å‹ *</label>
                <select id="stepAction" onchange="toggleActionFields()" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                    <option value="navigate">å¯¼èˆª</option>
                    <option value="click">ç‚¹å‡»</option>
                    <option value="input">è¾“å…¥</option>
                    <option value="hover">æ‚¬åœ</option>
                    <option value="double_click">åŒå‡»</option>
                    <option value="right_click">å³é”®ç‚¹å‡»</option>
                    <option value="wait">ç­‰å¾…</option>
                    <option value="scroll">æ»šåŠ¨</option>
                    <option value="text_compare">æ–‡æœ¬å¯¹æ¯”</option>
                </select>
            </div>
            <div class="form-group" id="stepWaitTimeField" style="display: none;">
                <label for="stepWaitTime">ç­‰å¾…æ—¶é—´ (ç§’)</label>
                <input type="number" id="stepWaitTime" placeholder="è¯·è¾“å…¥ç­‰å¾…æ—¶é—´" min="0" step="1" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
            </div>
            <!-- æ»šåŠ¨è·ç¦»å­—æ®µ (æ ¹æ®æ“ä½œç±»å‹åŠ¨æ€æ˜¾ç¤º) -->
            <div id="stepScrollFields" class="mt-4" style="display: none;">
                <div class="form-group">
                    <label>æ»šåŠ¨è·ç¦» (åƒç´ )</label>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <input type="number" id="stepScrollUp" placeholder="å‘ä¸Š" min="0" step="1" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        <div>
                            <input type="number" id="stepScrollDown" placeholder="å‘ä¸‹" min="0" step="1" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        <div>
                            <input type="number" id="stepScrollLeft" placeholder="å‘å·¦" min="0" step="1" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        <div>
                            <input type="number" id="stepScrollRight" placeholder="å‘å³" min="0" step="1" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                    </div>
                </div>
            </div>
            <!-- æ‚¬åœæ—¶é—´å­—æ®µ (æ ¹æ®æ“ä½œç±»å‹åŠ¨æ€æ˜¾ç¤º) -->
            <div id="stepHoverFields" class="mt-4" style="display: none;">
                <div class="form-group">
                    <label for="stepHoverTime">æ‚¬åœæ—¶é—´ (ç§’)</label>
                    <input type="number" id="stepHoverTime" placeholder="è¯·è¾“å…¥æ‚¬åœæ—¶é—´" min="0" step="0.1" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
            </div>
            
            <!-- æ“ä½œå€¼å­—æ®µ (æ ¹æ®æ“ä½œç±»å‹åŠ¨æ€æ˜¾ç¤º) -->
            <div id="stepValueFields" class="mt-4" style="display: none;">
                <!-- æ–‡æœ¬å¯¹æ¯”æ“ä½œçš„æ¯”è¾ƒæ–¹å¼é€‰æ‹© -->
                <div class="form-group" id="stepCompareTypeField" style="display: none;">
                    <label for="stepCompareType">æ¯”è¾ƒæ–¹å¼</label>
                    <select id="stepCompareType" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        <option value="equals">ç­‰äº</option>
                        <option value="not_equals">ä¸ç­‰äº</option>
                        <option value="contains">åŒ…å«</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="stepInputValue">æ“ä½œå€¼</label>
                    <input type="text" id="stepInputValue" placeholder="è¯·è¾“å…¥æ“ä½œå€¼" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
            </div>
            
            <!-- å®šä½æ–¹å¼å­—æ®µ -->
            <div id="stepSelectorTypeField" class="mt-4">
                <div class="form-group">
                    <label for="stepSelectorType">å®šä½æ–¹å¼</label>
                    <select id="stepSelectorType" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        <option value="css">CSSé€‰æ‹©å™¨</option>
                        <option value="xpath">XPath</option>
                        <option value="id">ID</option>
                        <option value="class">Class</option>
                        <option value="name">Name</option>
                    </select>
                </div>
            </div>
            
            <!-- å…ƒç´ å®šä½å­—æ®µ (åŒ…å«é€‰æ‹©å…ƒç´ æŒ‰é’®) -->
            <div id="stepElementNameField" class="mt-4">
                <div class="form-group">
                    <label for="stepSelectorValue">é€‰æ‹©å™¨å€¼</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="stepSelectorValue" placeholder="ä¾‹å¦‚: #username æˆ– //input[@id='username']" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        <button type="button" id="startSelectBtn" class="btn btn-primary" onclick="startVisualSelection()" style="display: none;">
                            <i class="fa fa-mouse-pointer"></i> é€‰æ‹©å…ƒç´ 
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- æ­¥éª¤æè¿°å­—æ®µ -->
            <div id="stepDescriptionField" class="mt-4">
                <div class="form-group">
                    <label for="stepDescription">æ­¥éª¤æè¿°</label>
                    <textarea id="stepDescription" placeholder="æè¿°æ­¤æ­¥éª¤çš„ç›®çš„" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"></textarea>
                </div>
            </div>
            
            <div class="iframe-switch-container">
                <label>
                    <input type="checkbox" id="stepIframeSwitch" class="rounded">
                    <span>æ˜¯å¦è¿›å…¥iframe</span>
                </label>
                <div id="stepIframeSelectorField" style="display: none;" class="iframe-selector-field">
                    <label for="stepIframeSelector">iframeé€‰æ‹©å™¨</label>
                    <input type="text" id="stepIframeSelector" placeholder="ä¾‹å¦‚: #myFrame æˆ– iframe[src='...']">
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closeCreateStepModal()" class="btn btn-secondary">å–æ¶ˆ</button>
                <button onclick="createStep()" class="btn btn-primary">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <!-- ç¼–è¾‘æ­¥éª¤æ¨¡æ€æ¡† -->
    <div id="editStepModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ç¼–è¾‘æµ‹è¯•æ­¥éª¤</h3>
            </div>
            <div class="form-group">
                <label for="editStepAction">æ“ä½œç±»å‹ *</label>
                <select id="editStepAction" onchange="toggleEditActionFields()">
                    <option value="navigate">å¯¼èˆª</option>
                    <option value="click">ç‚¹å‡»</option>
                    <option value="input">è¾“å…¥</option>
                    <option value="hover">æ‚¬åœ</option>
                    <option value="double_click">åŒå‡»</option>
                    <option value="right_click">å³é”®ç‚¹å‡»</option>
                    <option value="wait">ç­‰å¾…</option>
                    <option value="scroll">æ»šåŠ¨</option>
                    <option value="text_compare">æ–‡æœ¬å¯¹æ¯”</option>
                </select>
            </div>
            <div class="form-group" id="editStepWaitTimeField" style="display: none;">
                <label for="editStepWaitTime">ç­‰å¾…æ—¶é—´ (ç§’)</label>
                <input type="number" id="editStepWaitTime" placeholder="è¯·è¾“å…¥ç­‰å¾…æ—¶é—´" min="0" step="1">
            </div>
            <!-- æ»šåŠ¨è·ç¦»å­—æ®µ (æ ¹æ®æ“ä½œç±»å‹åŠ¨æ€æ˜¾ç¤º) -->
            <div id="editStepScrollFields" class="mt-4 hidden">
                <div class="form-group">
                    <label>æ»šåŠ¨è·ç¦» (åƒç´ )</label>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <input type="number" id="editStepScrollUp" placeholder="å‘ä¸Š" min="0" step="1">
                        </div>
                        <div>
                            <input type="number" id="editStepScrollDown" placeholder="å‘ä¸‹" min="0" step="1">
                        </div>
                        <div>
                            <input type="number" id="editStepScrollLeft" placeholder="å‘å·¦" min="0" step="1">
                        </div>
                        <div>
                            <input type="number" id="editStepScrollRight" placeholder="å‘å³" min="0" step="1">
                        </div>
                    </div>
                </div>
            </div>
            <!-- æ‚¬åœæ—¶é—´å­—æ®µ (æ ¹æ®æ“ä½œç±»å‹åŠ¨æ€æ˜¾ç¤º) -->
            <div id="editStepHoverFields" class="mt-4 hidden">
                <div class="form-group">
                    <label for="editStepHoverTime">æ‚¬åœæ—¶é—´ (ç§’)</label>
                    <input type="number" id="editStepHoverTime" placeholder="è¯·è¾“å…¥æ‚¬åœæ—¶é—´" min="0" step="0.1">
                </div>
            </div>
            
            <!-- æ“ä½œå€¼å­—æ®µ (æ ¹æ®æ“ä½œç±»å‹åŠ¨æ€æ˜¾ç¤º) -->
            <div id="editStepValueFields" class="mt-4" style="display: none;">
                <!-- æ–‡æœ¬å¯¹æ¯”æ“ä½œçš„æ¯”è¾ƒæ–¹å¼é€‰æ‹© -->
                <div class="form-group" id="editStepCompareTypeField" style="display: none;">
                    <label for="editStepCompareType">æ¯”è¾ƒæ–¹å¼</label>
                    <select id="editStepCompareType" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        <option value="equals">ç­‰äº</option>
                        <option value="not_equals">ä¸ç­‰äº</option>
                        <option value="contains">åŒ…å«</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editStepInputValue">æ“ä½œå€¼</label>
                    <input type="text" id="editStepInputValue" placeholder="è¯·è¾“å…¥æ“ä½œå€¼">
                </div>
            </div>
            
            <!-- å®šä½æ–¹å¼å­—æ®µ -->
            <div id="editStepSelectorTypeField" class="mt-4" style="display: none;">
                <div class="form-group">
                    <label for="editStepSelectorType">å®šä½æ–¹å¼</label>
                    <select id="editStepSelectorType">
                        <option value="css">CSSé€‰æ‹©å™¨</option>
                        <option value="xpath">XPath</option>
                        <option value="id">ID</option>
                        <option value="class">Class</option>
                        <option value="name">Name</option>
                    </select>
                </div>
            </div>
            
            <!-- å…ƒç´ å®šä½å­—æ®µ -->
            <div id="editStepElementNameField" class="mt-4" style="display: none;">
                <div class="form-group">
                    <label for="editStepSelectorValue">é€‰æ‹©å™¨å€¼</label>
                    <input type="text" id="editStepSelectorValue" placeholder="ä¾‹å¦‚: #username æˆ– //input[@id='username']">
                </div>
            </div>
            
            <!-- æ­¥éª¤æè¿°å­—æ®µ -->
            <div id="editStepDescriptionField" class="mt-4">
                <div class="form-group">
                    <label for="editStepDescription">æ­¥éª¤æè¿°</label>
                    <textarea id="editStepDescription" placeholder="æè¿°æ­¤æ­¥éª¤çš„ç›®çš„"></textarea>
                </div>
            </div>
            
            <div class="iframe-switch-container">
                <label>
                    <input type="checkbox" id="editStepIframeSwitch" class="rounded">
                    <span>æ˜¯å¦è¿›å…¥iframe</span>
                </label>
                <div id="editStepIframeSelectorField" style="display: none;" class="iframe-selector-field">
                    <label for="editStepIframeSelector">iframeé€‰æ‹©å™¨</label>
                    <input type="text" id="editStepIframeSelector" placeholder="ä¾‹å¦‚: #myFrame æˆ– iframe[src='...']">
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closeEditStepModal()" class="btn btn-secondary">å–æ¶ˆ</button>
                <button onclick="updateStep()" class="btn btn-primary">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <script>
        let currentCaseId = null;
        let currentCaseName = '';
        let currentEditingStepId = null;
        let currentProjectId = null;
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function getCaseIdFromSession() {
            return sessionStorage.getItem('currentCaseId');
        }
        
        function getProjectIdFromUrl() {
            const path = window.location.pathname;
            const parts = path.split('/');
            // å°è¯•ä»URLä¸­è·å–é¡¹ç›®IDï¼Œå¯èƒ½åœ¨ä¸åŒä½ç½®
            for (let i = 0; i < parts.length; i++) {
                if (parts[i] === 'list_steps' && parts[i + 1]) {
                    return parts[i + 1];
                }
            }
            return null;
        }
        
        async function loadCaseInfo() {
            console.log('=== å¼€å§‹åŠ è½½ç”¨ä¾‹ä¿¡æ¯ ===');
            currentCaseId = getCaseIdFromSession();
            console.log('è·å–åˆ°çš„ç”¨ä¾‹ID:', currentCaseId);
            
            if (!currentCaseId) {
                alert('æœªæ‰¾åˆ°ç”¨ä¾‹ä¿¡æ¯ï¼Œè¯·å…ˆé€‰æ‹©æµ‹è¯•ç”¨ä¾‹');
                window.location.href = '/list_projects';
                return;
            }
            
            try {
                console.log(`å°è¯•è·å–æµ‹è¯•ç”¨ä¾‹ä¿¡æ¯ï¼ŒID: ${currentCaseId}`);
                const response = await fetch(`/api/cases/${currentCaseId}`);
                console.log('APIå“åº”çŠ¶æ€:', response.status);
                
                if (!response.ok) {
                    throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('APIå“åº”æ•°æ®:', data);
                
                if (data.test_case) {
                    currentCaseName = data.test_case.name;
                    currentProjectId = data.test_case.project_id;
                    console.log('è·å–åˆ°çš„é¡¹ç›®ID:', currentProjectId);
                    
                    // åŒæ—¶å°†é¡¹ç›®IDå­˜å‚¨åˆ°sessionStorageä¸­ï¼Œä»¥ä¾¿åç»­ä½¿ç”¨
                    if (currentProjectId) {
                        sessionStorage.setItem('currentProjectId', currentProjectId);
                        console.log('é¡¹ç›®IDå·²å­˜å‚¨åˆ°sessionStorage:', currentProjectId);
                    }
                    
                    document.getElementById('caseInfo').textContent = `ç”¨ä¾‹: ${escapeHtml(currentCaseName)}`;
                } else {
                    console.error('æµ‹è¯•ç”¨ä¾‹ä¿¡æ¯ä¸å­˜åœ¨');
                    document.getElementById('caseInfo').textContent = `ç”¨ä¾‹: æœªçŸ¥ç”¨ä¾‹`;
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨ä¾‹ä¿¡æ¯å¤±è´¥:', error);
                document.getElementById('caseInfo').textContent = `ç”¨ä¾‹: æœªçŸ¥ç”¨ä¾‹`;
            }
        }
        
        async function loadSteps() {
            if (!currentCaseId) return;
            
            try {
                const response = await fetch(`/api/cases/${currentCaseId}/steps`);
                const data = await response.json();
                
                const stepsList = document.getElementById('stepsList');
                
                if (data.steps && data.steps.length > 0) {
                    stepsList.innerHTML = '<div class="steps-list" id="stepsListContainer"></div>';
                    const stepsListContainer = document.getElementById('stepsListContainer');
                    
                    data.steps.forEach((step, index) => {
                        const stepItem = document.createElement('div');
                        stepItem.className = 'step-item';
                        stepItem.id = `step-${step.id}`;
                        stepItem.dataset.stepId = step.id;
                        
                        let actionText = '';
                        switch (step.action) {
                            case 'navigate': actionText = 'å¯¼èˆª'; break;
                            case 'click': actionText = 'ç‚¹å‡»'; break;
                            case 'input': actionText = 'è¾“å…¥'; break;
                            case 'hover': actionText = 'æ‚¬åœ'; break;
                            case 'double_click': actionText = 'åŒå‡»'; break;
                            case 'right_click': actionText = 'å³é”®ç‚¹å‡»'; break;
                            case 'wait': actionText = 'ç­‰å¾…'; break;
                            case 'scroll': actionText = 'æ»šåŠ¨'; break;
                            case 'text_compare': actionText = 'æ–‡æœ¬å¯¹æ¯”'; break;
                            default: actionText = step.action;
                        }
                        
                        stepItem.innerHTML = `
                            <div class="step-number">${index + 1}</div>
                            <div class="step-content">
                                <h4>${step.description || actionText}</h4>
                                <div class="step-details">
                                    ${step.selector_type ? `<div><strong>å®šä½æ–¹å¼:</strong> ${escapeHtml(step.selector_type)}</div>` : ''}
                                    ${step.selector_value ? `<div><strong>é€‰æ‹©å™¨:</strong> ${escapeHtml(step.selector_value)}</div>` : ''}
                                    ${step.input_value ? `<div><strong>è¾“å…¥å€¼:</strong> ${escapeHtml(step.input_value)}</div>` : ''}
                                    ${step.description ? `<div><strong>æè¿°:</strong> ${escapeHtml(step.description)}</div>` : ''}
                                    ${step.enter_iframe ? `<div><strong>è¿›å…¥iframe:</strong> æ˜¯</div>` : ''}
                                    ${step.iframe_selector ? `<div><strong>iframeé€‰æ‹©å™¨:</strong> ${escapeHtml(step.iframe_selector)}</div>` : ''}
                                </div>
                            </div>
                            <div class="step-actions">
                                <button onclick="editStep(${step.id})" class="btn btn-sm btn-secondary">ç¼–è¾‘</button>
                                <button onclick="deleteStep(${step.id})" class="btn btn-sm btn-danger">åˆ é™¤</button>
                            </div>
                        `;
                        
                        stepsListContainer.appendChild(stepItem);
                    });
                    
                    // åˆå§‹åŒ–æ‹–åŠ¨æ’åºåŠŸèƒ½
                    initDragAndDrop();
                } else {
                    stepsList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“</div>
                            <div class="empty-state-text">è¯¥æµ‹è¯•ç”¨ä¾‹æš‚æ— æ­¥éª¤</div>
                            <button onclick="showCreateStepModal()" class="btn btn-primary">æ·»åŠ ç¬¬ä¸€ä¸ªæ­¥éª¤</button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('åŠ è½½æµ‹è¯•æ­¥éª¤å¤±è´¥:', error);
                document.getElementById('stepsList').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">âŒ</div>
                        <div class="empty-state-text">åŠ è½½æµ‹è¯•æ­¥éª¤å¤±è´¥</div>
                        <button onclick="loadSteps()" class="btn btn-primary">é‡æ–°åŠ è½½</button>
                    </div>
                `;
            }
        }
        
        function showCreateStepModal() {
            document.getElementById('createStepModal').classList.add('active');
            document.getElementById('stepAction').value = 'click';
            document.getElementById('stepSelectorType').value = 'css';
            document.getElementById('stepSelectorValue').value = '';
            document.getElementById('stepInputValue').value = '';
            document.getElementById('stepDescription').value = '';
            document.getElementById('stepIframeSwitch').checked = false;
            document.getElementById('stepIframeSelector').value = '';
            document.getElementById('stepIframeSelectorField').style.display = 'none';
            toggleActionFields();
        }
        
        function closeCreateStepModal() {
            document.getElementById('createStepModal').classList.remove('active');
        }
        
        function showEditStepModal(step) {
            currentEditingStepId = step.id;
            document.getElementById('editStepModal').classList.add('active');
            document.getElementById('editStepAction').value = step.action;
            document.getElementById('editStepSelectorType').value = step.selector_type || 'css';
            document.getElementById('editStepSelectorValue').value = step.selector_value || '';
            document.getElementById('editStepInputValue').value = step.input_value || '';
            document.getElementById('editStepWaitTime').value = step.input_value || '';
            document.getElementById('editStepHoverTime').value = step.input_value || '';
            // è®¾ç½®æ¯”è¾ƒæ–¹å¼ï¼ˆä»…æ–‡æœ¬å¯¹æ¯”æ“ä½œéœ€è¦ï¼‰
            document.getElementById('editStepCompareType').value = step.compare_type || 'equals';
            
            // å¤„ç†æ»šåŠ¨æ“ä½œçš„æ»šåŠ¨è·ç¦»
            if (step.action === 'scroll') {
                try {
                    const scrollData = JSON.parse(step.input_value);
                    document.getElementById('editStepScrollUp').value = scrollData.up || 0;
                    document.getElementById('editStepScrollDown').value = scrollData.down || 0;
                    document.getElementById('editStepScrollLeft').value = scrollData.left || 0;
                    document.getElementById('editStepScrollRight').value = scrollData.right || 0;
                } catch (e) {
                    // å¦‚æœè§£æå¤±è´¥ï¼Œè®¾ç½®é»˜è®¤å€¼
                    document.getElementById('editStepScrollUp').value = 0;
                    document.getElementById('editStepScrollDown').value = 0;
                    document.getElementById('editStepScrollLeft').value = 0;
                    document.getElementById('editStepScrollRight').value = 0;
                }
            } else {
                // éæ»šåŠ¨æ“ä½œæ—¶æ¸…ç©ºæ»šåŠ¨è·ç¦»å­—æ®µ
                document.getElementById('editStepScrollUp').value = '';
                document.getElementById('editStepScrollDown').value = '';
                document.getElementById('editStepScrollLeft').value = '';
                document.getElementById('editStepScrollRight').value = '';
            }
            
            // éæ‚¬åœæ“ä½œæ—¶æ¸…ç©ºæ‚¬åœæ—¶é—´å­—æ®µ
            if (step.action !== 'hover') {
                document.getElementById('editStepHoverTime').value = '';
            }
            
            document.getElementById('editStepDescription').value = step.description || '';
            document.getElementById('editStepIframeSwitch').checked = step.enter_iframe || false;
            document.getElementById('editStepIframeSelector').value = step.iframe_selector || '';
            document.getElementById('editStepIframeSelectorField').style.display = (step.enter_iframe || false) ? 'block' : 'none';
            toggleEditActionFields();
        }
        
        function closeEditStepModal() {
            document.getElementById('editStepModal').classList.remove('active');
            currentEditingStepId = null;
        }
        
        function runTestCase() {
            if (!currentCaseId) {
                alert('æœªæ‰¾åˆ°ç”¨ä¾‹ä¿¡æ¯');
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½æç¤º
            const originalButton = document.querySelector('button[onclick="runTestCase()"]');
            const originalText = originalButton.innerHTML;
            originalButton.innerHTML = '<div class="loading-spinner" style="width: 16px; height: 16px; border: 2px solid #fff; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>';
            originalButton.disabled = true;
            
            // è°ƒç”¨APIè¿è¡Œæµ‹è¯•ç”¨ä¾‹
            fetch(`/api/cases/${currentCaseId}/run`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showRunResultModal(`
                        <div style="padding: 20px;">
                            <h4>æ‰§è¡Œç»“æœ</h4>
                            <p><strong>çŠ¶æ€:</strong> æˆåŠŸ</p>
                            <p>æµ‹è¯•ç”¨ä¾‹è¿è¡ŒæˆåŠŸï¼</p>
                        </div>
                    `);
                } else {
                    showRunResultModal(`
                        <div style="padding: 20px; color: red;">
                            <h4>æ‰§è¡Œå¤±è´¥</h4>
                            <p>${escapeHtml(data.error || 'æœªçŸ¥é”™è¯¯')}</p>
                        </div>
                    `);
                }
            })
            .catch(error => {
                showRunResultModal(`
                    <div style="padding: 20px; color: red;">
                        <h4>æ‰§è¡Œå¤±è´¥</h4>
                        <p>å‘ç”Ÿé”™è¯¯: ${error.message}</p>
                    </div>
                `);
            })
            .finally(() => {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                originalButton.innerHTML = originalText;
                originalButton.disabled = false;
            });
        }
        
        function backToCases() {
            // æœ€ç®€å•çš„æ–¹æ³•ï¼šç›´æ¥è¿”å›ä¸Šä¸€é¡µ
            window.history.back();
        }
        
        // åˆå§‹åŒ–æ‹–åŠ¨æ’åºåŠŸèƒ½
        function initDragAndDrop() {
            const stepsListContainer = document.getElementById('stepsListContainer');
            const stepItems = document.querySelectorAll('.step-item');
            
            let draggedItem = null;
            let scrollInterval = null;
            
            // æ·»åŠ é¼ æ ‡æ»šè½®æ”¯æŒ - ç›´æ¥æ·»åŠ åˆ°documentä¸Šï¼Œç¡®ä¿å³ä½¿é¼ æ ‡ä¸åœ¨å®¹å™¨å†…ä¹Ÿèƒ½æ»šåŠ¨
            document.addEventListener('wheel', function(e) {
                if (draggedItem) {
                    e.preventDefault();
                    const delta = e.deltaY > 0 ? 20 : -20;
                    stepsListContainer.scrollTop += delta;
                }
            }, { passive: false });
            
            stepItems.forEach(item => {
                // æ‹–åŠ¨å¼€å§‹
                item.addEventListener('dragstart', function(e) {
                    draggedItem = this;
                    setTimeout(() => {
                        this.classList.add('dragging');
                    }, 0);
                });
                
                // æ‹–åŠ¨ç»“æŸ
                item.addEventListener('dragend', function(e) {
                    this.classList.remove('dragging');
                    draggedItem = null;
                    
                    // æ¸…é™¤æ‰€æœ‰overç±»
                    document.querySelectorAll('.step-item').forEach(el => {
                        el.classList.remove('over');
                    });
                    
                    // æ¸…é™¤è‡ªåŠ¨æ»šåŠ¨å®šæ—¶å™¨
                    if (scrollInterval) {
                        clearInterval(scrollInterval);
                        scrollInterval = null;
                    }
                    
                    // æ›´æ–°æ­¥éª¤ç¼–å·
                    updateStepNumbers();
                    
                    // ä¿å­˜æ–°çš„é¡ºåº
                    saveStepOrder();
                });
                
                // æ‹–åŠ¨ç»è¿‡
                item.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    
                    // è®¡ç®—æ‹–åŠ¨æ–¹å‘
                    const rect = this.getBoundingClientRect();
                    const y = e.clientY - rect.top;
                    
                    // æ¸…é™¤æ‰€æœ‰overç±»
                    document.querySelectorAll('.step-item').forEach(el => {
                        el.classList.remove('over');
                    });
                    
                    // æ ¹æ®é¼ æ ‡ä½ç½®æ·»åŠ overç±»
                    if (this !== draggedItem) {
                        this.classList.add('over');
                    }
                    
                    // è‡ªåŠ¨æ»šåŠ¨
                    const containerRect = stepsListContainer.getBoundingClientRect();
                    const scrollThreshold = 80; // å¢åŠ é˜ˆå€¼ï¼Œä½¿è‡ªåŠ¨æ»šåŠ¨æ›´å®¹æ˜“è§¦å‘
                    const scrollSpeed = 8; // å¢åŠ æ»šåŠ¨é€Ÿåº¦
                    
                    // æ¸…é™¤ä¹‹å‰çš„æ»šåŠ¨å®šæ—¶å™¨
                    if (scrollInterval) {
                        clearInterval(scrollInterval);
                        scrollInterval = null;
                    }
                    
                    // è®¡ç®—æ»šåŠ¨æ–¹å‘å’Œé€Ÿåº¦
                    if (e.clientY < containerRect.top + scrollThreshold) {
                        // å‘ä¸Šæ»šåŠ¨
                        scrollInterval = setInterval(() => {
                            stepsListContainer.scrollTop -= scrollSpeed;
                        }, 20);
                    } else if (e.clientY > containerRect.bottom - scrollThreshold) {
                        // å‘ä¸‹æ»šåŠ¨
                        scrollInterval = setInterval(() => {
                            stepsListContainer.scrollTop += scrollSpeed;
                        }, 20);
                    }
                });
                
                // æ‹–åŠ¨è¿›å…¥
                item.addEventListener('dragenter', function(e) {
                    e.preventDefault();
                });
                
                // æ‹–åŠ¨ç¦»å¼€
                item.addEventListener('dragleave', function(e) {
                    // åªæœ‰å½“ç¦»å¼€å…ƒç´ æ—¶æ‰ç§»é™¤overç±»
                    if (!this.contains(e.relatedTarget)) {
                        this.classList.remove('over');
                    }
                });
                
                // æ”¾ç½®
                item.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('over');
                    
                    // æ¸…é™¤è‡ªåŠ¨æ»šåŠ¨å®šæ—¶å™¨
                    if (scrollInterval) {
                        clearInterval(scrollInterval);
                        scrollInterval = null;
                    }
                    
                    if (this !== draggedItem) {
                        const container = stepsListContainer;
                        
                        // è®¡ç®—æ”¾ç½®ä½ç½®
                        const rect = this.getBoundingClientRect();
                        const y = e.clientY - rect.top;
                        
                        // å¦‚æœé¼ æ ‡åœ¨å…ƒç´ çš„ä¸ŠåŠéƒ¨åˆ†ï¼Œæ”¾åœ¨å…ƒç´ å‰é¢ï¼›å¦åˆ™æ”¾åœ¨å…ƒç´ åé¢
                        if (y < rect.height / 2) {
                            container.insertBefore(draggedItem, this);
                        } else {
                            container.insertBefore(draggedItem, this.nextSibling);
                        }
                    }
                });
                
                // è®¾ç½®å¯æ‹–åŠ¨
                item.setAttribute('draggable', 'true');
            });
        }
        
        // æ›´æ–°æ­¥éª¤ç¼–å·
        function updateStepNumbers() {
            const stepItems = document.querySelectorAll('.step-item');
            stepItems.forEach((item, index) => {
                const stepNumber = item.querySelector('.step-number');
                if (stepNumber) {
                    stepNumber.textContent = index + 1;
                }
            });
        }
        
        // ä¿å­˜æ­¥éª¤é¡ºåº
        async function saveStepOrder() {
            const stepItems = document.querySelectorAll('.step-item');
            const stepOrder = [];
            
            stepItems.forEach((item, index) => {
                const stepId = item.dataset.stepId;
                if (stepId) {
                    stepOrder.push({
                        id: parseInt(stepId),
                        order: index + 1
                    });
                }
            });
            
            try {
                const response = await fetch(`/api/cases/${currentCaseId}/steps/order`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ steps: stepOrder })
                });
                
                const data = await response.json();
                if (!data.success) {
                    console.error('ä¿å­˜æ­¥éª¤é¡ºåºå¤±è´¥:', data.error);
                    // é‡æ–°åŠ è½½æ­¥éª¤ä»¥æ¢å¤åŸå§‹é¡ºåº
                    loadSteps();
                }
            } catch (error) {
                console.error('ä¿å­˜æ­¥éª¤é¡ºåºæ—¶å‡ºé”™:', error);
                // é‡æ–°åŠ è½½æ­¥éª¤ä»¥æ¢å¤åŸå§‹é¡ºåº
                loadSteps();
            }
        }
        
        function createStep() {
            const action = document.getElementById('stepAction').value;
            const selectorType = document.getElementById('stepSelectorType').value;
            const selectorValue = document.getElementById('stepSelectorValue').value;
            const inputValue = document.getElementById('stepInputValue').value;
            const description = document.getElementById('stepDescription').value;
            const enterIframe = document.getElementById('stepIframeSwitch').checked;
            const iframeSelector = document.getElementById('stepIframeSelector').value;
            // è·å–æ¯”è¾ƒæ–¹å¼ï¼ˆä»…æ–‡æœ¬å¯¹æ¯”æ“ä½œéœ€è¦ï¼‰
            const compareType = action === 'text_compare' ? document.getElementById('stepCompareType').value : null;
            
            // éªŒè¯å¿…å¡«å­—æ®µ
            if (!action) {
                alert('è¯·é€‰æ‹©æ“ä½œç±»å‹');
                return;
            }
            
            // å¯¹äºéœ€è¦é€‰æ‹©å™¨çš„æ“ä½œï¼ŒéªŒè¯é€‰æ‹©å™¨
            if (action !== 'navigate' && action !== 'wait') {
                if (!selectorValue) {
                    alert('è¯·å¡«å†™é€‰æ‹©å™¨å€¼');
                    return;
                }
            }
            
            // å¯¹äºå¯¼èˆªæ“ä½œï¼ŒéªŒè¯ URL
            if (action === 'navigate' && !inputValue) {
                alert('è¯·å¡«å†™å¯¼èˆª URL');
                return;
            }
            
            // æ„å»ºè¯·æ±‚æ•°æ®
            const stepData = {
                case_id: currentCaseId,
                action: action,
                selector_type: selectorType,
                selector_value: selectorValue,
                input_value: inputValue,
                description: description,
                enter_iframe: enterIframe,
                iframe_selector: iframeSelector
            };
            
            // æ·»åŠ æ¯”è¾ƒæ–¹å¼ï¼ˆä»…æ–‡æœ¬å¯¹æ¯”æ“ä½œéœ€è¦ï¼‰
            if (action === 'text_compare' && compareType) {
                stepData.compare_type = compareType;
            }
            
            // è°ƒç”¨ API åˆ›å»ºæ­¥éª¤
            fetch('/api/steps', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(stepData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('æ­¥éª¤åˆ›å»ºæˆåŠŸï¼');
                    closeCreateStepModal();
                    loadSteps(); // åˆ·æ–°æ­¥éª¤åˆ—è¡¨
                } else {
                    alert('æ­¥éª¤åˆ›å»ºå¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            })
            .catch(error => {
                alert('æ­¥éª¤åˆ›å»ºæ—¶å‘ç”Ÿé”™è¯¯: ' + error.message);
            });
        }
        
        function updateStep() {
            if (!currentEditingStepId) {
                alert('æœªæ‰¾åˆ°è¦ç¼–è¾‘çš„æ­¥éª¤');
                return;
            }
            
            const action = document.getElementById('editStepAction').value;
            const selectorType = document.getElementById('editStepSelectorType').value;
            const selectorValue = document.getElementById('editStepSelectorValue').value;
            const inputValue = document.getElementById('editStepInputValue').value;
            const description = document.getElementById('editStepDescription').value;
            const enterIframe = document.getElementById('editStepIframeSwitch').checked;
            const iframeSelector = document.getElementById('editStepIframeSelector').value;
            // è·å–æ¯”è¾ƒæ–¹å¼ï¼ˆä»…æ–‡æœ¬å¯¹æ¯”æ“ä½œéœ€è¦ï¼‰
            const compareType = action === 'text_compare' ? document.getElementById('editStepCompareType').value : null;
            
            // éªŒè¯å¿…å¡«å­—æ®µ
            if (!action) {
                alert('è¯·é€‰æ‹©æ“ä½œç±»å‹');
                return;
            }
            
            // å¯¹äºéœ€è¦é€‰æ‹©å™¨çš„æ“ä½œï¼ŒéªŒè¯é€‰æ‹©å™¨
            if (action !== 'navigate' && action !== 'wait') {
                if (!selectorValue) {
                    alert('è¯·å¡«å†™é€‰æ‹©å™¨å€¼');
                    return;
                }
            }
            
            // å¯¹äºå¯¼èˆªæ“ä½œï¼ŒéªŒè¯ URL
            if (action === 'navigate' && !inputValue) {
                alert('è¯·å¡«å†™å¯¼èˆª URL');
                return;
            }
            
            // æ„å»ºè¯·æ±‚æ•°æ®
            const stepData = {
                action: action,
                selector_type: selectorType,
                selector_value: selectorValue,
                input_value: inputValue,
                description: description,
                enter_iframe: enterIframe,
                iframe_selector: iframeSelector
            };
            
            // æ·»åŠ æ¯”è¾ƒæ–¹å¼ï¼ˆä»…æ–‡æœ¬å¯¹æ¯”æ“ä½œéœ€è¦ï¼‰
            if (action === 'text_compare' && compareType) {
                stepData.compare_type = compareType;
            }
            
            // è°ƒç”¨ API æ›´æ–°æ­¥éª¤
            fetch(`/api/steps/${currentEditingStepId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(stepData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('æ­¥éª¤æ›´æ–°æˆåŠŸï¼');
                    closeEditStepModal();
                    loadSteps(); // åˆ·æ–°æ­¥éª¤åˆ—è¡¨
                } else {
                    alert('æ­¥éª¤æ›´æ–°å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            })
            .catch(error => {
                alert('æ­¥éª¤æ›´æ–°æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message);
            });
        }
        
        function deleteStep(stepId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæµ‹è¯•æ­¥éª¤å—ï¼Ÿ')) {
                return;
            }
            
            // è°ƒç”¨ API åˆ é™¤æ­¥éª¤
            fetch(`/api/steps/${stepId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('æ­¥éª¤åˆ é™¤æˆåŠŸï¼');
                    loadSteps(); // åˆ·æ–°æ­¥éª¤åˆ—è¡¨
                } else {
                    alert('æ­¥éª¤åˆ é™¤å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            })
            .catch(error => {
                alert('æ­¥éª¤åˆ é™¤æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message);
            });
        }
        
        function editStep(stepId) {
            // è°ƒç”¨ API è·å–æ­¥éª¤è¯¦æƒ…
            fetch(`/api/steps/${stepId}`)
            .then(response => response.json())
            .then(data => {
                if (data.step) {
                    showEditStepModal(data.step);
                } else {
                    alert('è·å–æ­¥éª¤è¯¦æƒ…å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            })
            .catch(error => {
                alert('è·å–æ­¥éª¤è¯¦æƒ…æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message);
            });
        }
        
        function startVisualSelection() {
            // æ˜¾ç¤ºæç¤ºä¿¡æ¯
            alert('è¯·åœ¨æ–°æ‰“å¼€çš„æµè§ˆå™¨çª—å£ä¸­é€‰æ‹©å…ƒç´ ï¼Œé€‰æ‹©å®Œæˆåå›åˆ°æ­¤é¡µé¢');
            
            // è·å–ç”¨ä¾‹çš„å¯¼èˆªURL
            async function getNavigationUrl() {
                try {
                    const response = await fetch(`/api/cases/${currentCaseId}/steps`);
                    const data = await response.json();
                    
                    if (data.steps && data.steps.length > 0) {
                        // æŸ¥æ‰¾å¯¼èˆªæ­¥éª¤
                        const navigateStep = data.steps.find(step => step.action === 'navigate');
                        if (navigateStep && navigateStep.input_value) {
                            return navigateStep.input_value;
                        }
                    }
                    // å¦‚æœæ²¡æœ‰å¯¼èˆªæ­¥éª¤ï¼Œä½¿ç”¨ç³»ç»ŸURLä½œä¸ºåå¤‡
                    return window.location.origin;
                } catch (error) {
                    console.error('è·å–å¯¼èˆªURLå¤±è´¥:', error);
                    return window.location.origin;
                }
            }
            
            // è°ƒç”¨APIå¯åŠ¨å¯è§†åŒ–é€‰æ‹©
            getNavigationUrl().then(url => {
                fetch('/api/start_visual_selection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        url: url
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // å®šæœŸæ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†å…ƒç´ 
                        checkSelectedElement();
                    } else {
                        alert('å¯åŠ¨å…ƒç´ é€‰æ‹©å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                    }
                })
                .catch(error => {
                    alert('å¯åŠ¨å…ƒç´ é€‰æ‹©æ—¶å‡ºé”™: ' + error.message);
                });
            });
        }
        
        function checkSelectedElement() {
            // æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†å…ƒç´ 
            fetch('/api/check_selected_element')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.selected_element) {
                    const element = data.selected_element;
                    document.getElementById('stepSelectorValue').value = element.selector;
                    document.getElementById('stepSelectorType').value = element.selector_type || 'css';
                    alert('å…ƒç´ é€‰æ‹©æˆåŠŸï¼');
                } else {
                    // ç»§ç»­æ£€æŸ¥
                    setTimeout(checkSelectedElement, 2000);
                }
            })
            .catch(error => {
                // å¿½ç•¥é”™è¯¯ï¼Œç»§ç»­æ£€æŸ¥
                setTimeout(checkSelectedElement, 2000);
            });
        }
        
        function toggleActionFields() {
            const action = document.getElementById('stepAction').value;
            const selectorTypeField = document.getElementById('stepSelectorTypeField');
            const selectorValueField = document.getElementById('stepElementNameField');
            const inputValueField = document.getElementById('stepValueFields');
            const waitTimeField = document.getElementById('stepWaitTimeField');
            const scrollFields = document.getElementById('stepScrollFields');
            const hoverFields = document.getElementById('stepHoverFields');
            const startSelectBtn = document.getElementById('startSelectBtn');
            
            // é‡ç½®æ‰€æœ‰å­—æ®µ
            selectorTypeField.style.display = 'none';
            selectorValueField.style.display = 'none';
            inputValueField.style.display = 'none';
            waitTimeField.style.display = 'none';
            scrollFields.style.display = 'none';
            hoverFields.style.display = 'none';
            if (startSelectBtn) startSelectBtn.style.display = 'none';
            // éšè—æ¯”è¾ƒæ–¹å¼é€‰æ‹©æ¡†
            const compareTypeField = document.getElementById('stepCompareTypeField');
            if (compareTypeField) compareTypeField.style.display = 'none';
            
            // æ ¹æ®æ“ä½œç±»å‹æ˜¾ç¤ºå¯¹åº”çš„å­—æ®µ
            if (action === 'wait') {
                waitTimeField.style.display = 'block';
            } else if (action === 'scroll') {
                selectorTypeField.style.display = 'block';
                selectorValueField.style.display = 'block';
                scrollFields.style.display = 'block';
            } else if (action === 'hover') {
                selectorTypeField.style.display = 'block';
                selectorValueField.style.display = 'block';
                hoverFields.style.display = 'block';
            } else if (action === 'navigate') {
                inputValueField.style.display = 'block';
                document.querySelector('label[for="stepInputValue"]').textContent = 'URL (å¯¼èˆª)';
            } else if (action === 'input') {
                selectorTypeField.style.display = 'block';
                selectorValueField.style.display = 'block';
                inputValueField.style.display = 'block';
                document.querySelector('label[for="stepInputValue"]').textContent = 'è¾“å…¥å€¼';
            } else if (action === 'text_compare') {
                selectorTypeField.style.display = 'block';
                selectorValueField.style.display = 'block';
                inputValueField.style.display = 'block';
                document.querySelector('label[for="stepInputValue"]').textContent = 'é¢„æœŸæ–‡æœ¬ (å¯é€‰)';
                if (startSelectBtn) startSelectBtn.style.display = 'none';
                // æ˜¾ç¤ºæ¯”è¾ƒæ–¹å¼é€‰æ‹©æ¡†
                const compareTypeField = document.getElementById('stepCompareTypeField');
                if (compareTypeField) compareTypeField.style.display = 'block';
            } else {
                selectorTypeField.style.display = 'block';
                selectorValueField.style.display = 'block';
                // é™¤äº†æ–‡æœ¬å¯¹æ¯”ä»¥å¤–çš„æ“ä½œï¼Œä¸æ˜¾ç¤ºè¾“å…¥å€¼å­—æ®µ
                inputValueField.style.display = 'none';
            }
        }
        
        function toggleEditActionFields() {
            const action = document.getElementById('editStepAction').value;
            const selectorTypeField = document.getElementById('editStepSelectorTypeField');
            const selectorValueField = document.getElementById('editStepElementNameField');
            const inputValueField = document.getElementById('editStepValueFields');
            const waitTimeField = document.getElementById('editStepWaitTimeField');
            const scrollFields = document.getElementById('editStepScrollFields');
            const hoverFields = document.getElementById('editStepHoverFields');
            
            // é‡ç½®æ‰€æœ‰å­—æ®µ
            selectorTypeField.style.display = 'none';
            selectorValueField.style.display = 'none';
            inputValueField.style.display = 'none';
            waitTimeField.style.display = 'none';
            scrollFields.style.display = 'none';
            hoverFields.style.display = 'none';
            // éšè—æ¯”è¾ƒæ–¹å¼é€‰æ‹©æ¡†
            const compareTypeField = document.getElementById('editStepCompareTypeField');
            if (compareTypeField) compareTypeField.style.display = 'none';
            
            // æ ¹æ®æ“ä½œç±»å‹æ˜¾ç¤ºå¯¹åº”çš„å­—æ®µ
            if (action === 'wait') {
                waitTimeField.style.display = 'block';
            } else if (action === 'scroll') {
                selectorTypeField.style.display = 'block';
                selectorValueField.style.display = 'block';
                scrollFields.style.display = 'block';
            } else if (action === 'hover') {
                selectorTypeField.style.display = 'block';
                selectorValueField.style.display = 'block';
                hoverFields.style.display = 'block';
            } else if (action === 'navigate') {
                inputValueField.style.display = 'block';
                document.querySelector('label[for="editStepInputValue"]').textContent = 'URL (å¯¼èˆª)';
            } else if (action === 'input') {
                selectorTypeField.style.display = 'block';
                selectorValueField.style.display = 'block';
                inputValueField.style.display = 'block';
                document.querySelector('label[for="editStepInputValue"]').textContent = 'è¾“å…¥å€¼';
            } else if (action === 'text_compare') {
                selectorTypeField.style.display = 'block';
                selectorValueField.style.display = 'block';
                inputValueField.style.display = 'block';
                document.querySelector('label[for="editStepInputValue"]').textContent = 'é¢„æœŸæ–‡æœ¬ (å¯é€‰)';
                // æ˜¾ç¤ºæ¯”è¾ƒæ–¹å¼é€‰æ‹©æ¡†
                if (compareTypeField) compareTypeField.style.display = 'block';
            } else {
                selectorTypeField.style.display = 'block';
                selectorValueField.style.display = 'block';
                // é™¤äº†æ–‡æœ¬å¯¹æ¯”ä»¥å¤–çš„æ“ä½œï¼Œä¸æ˜¾ç¤ºè¾“å…¥å€¼å­—æ®µ
                inputValueField.style.display = 'none';
            }
        }
        
        // å¤„ç†iframeå¼€å…³çš„æ˜¾ç¤º/éšè—é€»è¾‘
        document.addEventListener('DOMContentLoaded', function() {
            // ä¸ºåˆ›å»ºæ­¥éª¤æ¨¡æ€æ¡†çš„iframeå¼€å…³æ·»åŠ äº‹ä»¶ç›‘å¬
            const stepIframeSwitch = document.getElementById('stepIframeSwitch');
            if (stepIframeSwitch) {
                stepIframeSwitch.addEventListener('change', function() {
                    const stepIframeSelectorField = document.getElementById('stepIframeSelectorField');
                    if (stepIframeSelectorField) {
                        stepIframeSelectorField.style.display = this.checked ? 'block' : 'none';
                    }
                });
            }
            
            // ä¸ºç¼–è¾‘æ­¥éª¤æ¨¡æ€æ¡†çš„iframeå¼€å…³æ·»åŠ äº‹ä»¶ç›‘å¬
            const editStepIframeSwitch = document.getElementById('editStepIframeSwitch');
            if (editStepIframeSwitch) {
                editStepIframeSwitch.addEventListener('change', function() {
                    const editStepIframeSelectorField = document.getElementById('editStepIframeSelectorField');
                    if (editStepIframeSelectorField) {
                        editStepIframeSelectorField.style.display = this.checked ? 'block' : 'none';
                    }
                });
            }
            
            // åˆå§‹åŒ–é¡µé¢
            async function initPage() {
                await loadCaseInfo();
                await loadSteps();
            }
            
            initPage();
        });
        
        // æ˜¾ç¤ºè¿è¡Œç»“æœæ¨¡æ€æ¡†
        function showRunResultModal(content) {
            // åˆ›å»ºæ¨¡æ€æ¡†å…ƒç´ 
            let modal = document.getElementById('runResultModal');
            if (!modal) {
                // å¦‚æœæ¨¡æ€æ¡†ä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ª
                modal = document.createElement('div');
                modal.id = 'runResultModal';
                modal.className = 'modal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0, 0, 0, 0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 1000;
                    opacity: 0;
                    transition: opacity 0.3s ease;
                `;
                
                // åˆ›å»ºæ¨¡æ€æ¡†å†…å®¹
                const modalContent = document.createElement('div');
                modalContent.className = 'modal-content';
                modalContent.style.cssText = `
                    background-color: white;
                    padding: 30px;
                    border-radius: 8px;
                    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                    max-width: 500px;
                    width: 90%;
                    max-height: 80vh;
                    overflow-y: auto;
                `;
                
                // åˆ›å»ºå…³é—­æŒ‰é’®
                const closeButton = document.createElement('button');
                closeButton.innerText = 'ç¡®å®š';
                closeButton.style.cssText = `
                    margin-top: 20px;
                    padding: 10px 20px;
                    background-color: #3b82f6;
                    color: white;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 14px;
                `;
                closeButton.onclick = closeRunResultModal;
                
                // åˆ›å»ºå†…å®¹å®¹å™¨
                const contentDiv = document.createElement('div');
                contentDiv.id = 'runResultContent';
                
                // ç»„è£…æ¨¡æ€æ¡†
                modalContent.appendChild(contentDiv);
                modalContent.appendChild(closeButton);
                modal.appendChild(modalContent);
                document.body.appendChild(modal);
            }
            
            // è®¾ç½®æ¨¡æ€æ¡†å†…å®¹
            document.getElementById('runResultContent').innerHTML = content;
            modal.classList.add('active');
            modal.style.opacity = '1';
            
            // ç§»é™¤è‡ªåŠ¨å…³é—­æ¨¡æ€æ¡†çš„ä»£ç ï¼Œè®©ç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»"ç¡®å®š"æŒ‰é’®æ¥å…³é—­æ¨¡æ€æ¡†
        }
        
        // å…³é—­è¿è¡Œç»“æœæ¨¡æ€æ¡†
        function closeRunResultModal() {
            const modal = document.getElementById('runResultModal');
            if (modal) {
                modal.style.opacity = '0';
                setTimeout(() => {
                    modal.classList.remove('active');
                }, 300);
            }
        }
    </script>
</body>
</html>