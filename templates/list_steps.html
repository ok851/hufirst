<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•ç”¨ä¾‹æ­¥éª¤ç®¡ç† - UIè‡ªåŠ¨åŒ–æµ‹è¯•å¹³å°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .header .case-info {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .toolbar {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .toolbar-left {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .toolbar-right {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #545b62;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .content {
            padding: 30px;
        }
        
        .steps-list {
            margin-top: 20px;
        }
        
        .step-item {
            display: flex;
            align-items: flex-start;
            padding: 15px 20px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 10px;
            background: white;
            transition: all 0.3s ease;
        }
        
        .step-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-color: #667eea;
        }
        
        .step-number {
            background: #667eea;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            margin-right: 15px;
            flex-shrink: 0;
        }
        
        .step-content {
            flex: 1;
            padding: 0 15px;
        }
        
        .step-content h4 {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .step-details {
            font-size: 13px;
            color: #666;
            line-height: 1.4;
        }
        
        .step-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }
        
        .empty-state-text {
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 500px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            margin-bottom: 20px;
        }
        
        .modal-header h3 {
            color: #333;
            font-size: 22px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }
        
        .form-group textarea {
            height: 100px;
            resize: vertical;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        /* iframeå¼€å…³æ ·å¼ä¼˜åŒ– */
        .iframe-switch-container {
            margin-bottom: 16px;
        }
        .iframe-switch-container label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-weight: 500;
            color: #374151;
        }
        .iframe-switch-container input[type="checkbox"] {
            position: relative;
            width: 40px;
            height: 20px;
            appearance: none;
            background-color: #e5e7eb;
            border-radius: 10px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .iframe-switch-container input[type="checkbox"]:checked {
            background-color: #3b82f6;
        }
        .iframe-switch-container input[type="checkbox"]::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 16px;
            height: 16px;
            background-color: white;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        .iframe-switch-container input[type="checkbox"]:checked::before {
            transform: translateX(20px);
        }
        .iframe-selector-field {
            margin-top: 12px;
            padding: 16px;
            background-color: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            transition: all 0.3s ease;
        }
        .iframe-selector-field label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
            color: #4b5563;
        }
        .iframe-selector-field input {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        .iframe-selector-field input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .iframe-selector-field input::placeholder {
            color: #9ca3af;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>æµ‹è¯•ç”¨ä¾‹æ­¥éª¤ç®¡ç†</h1>
            <div class="case-info" id="caseInfo">æ­£åœ¨åŠ è½½ç”¨ä¾‹ä¿¡æ¯...</div>
        </div>
        
        <div class="toolbar">
            <div class="toolbar-left">
                <button onclick="showCreateStepModal()" class="btn btn-primary">+ æ·»åŠ æ­¥éª¤</button>
                <button onclick="runTestCase()" class="btn btn-success">â–¶ è¿è¡Œç”¨ä¾‹</button>
            </div>
            <div class="toolbar-right">
                <button onclick="backToCases()" class="btn btn-secondary">â† è¿”å›ç”¨ä¾‹åˆ—è¡¨</button>
            </div>
        </div>
        
        <div class="content">
            <div id="stepsList">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>æ­£åœ¨åŠ è½½æµ‹è¯•æ­¥éª¤...</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- åˆ›å»ºæ­¥éª¤æ¨¡æ€æ¡† -->
    <div id="createStepModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>æ·»åŠ æµ‹è¯•æ­¥éª¤</h3>
            </div>
            <div class="form-group">
                <label for="stepAction">æ“ä½œç±»å‹ *</label>
                <select id="stepAction" onchange="toggleActionFields()">
                    <option value="navigate">å¯¼èˆª</option>
                    <option value="click">ç‚¹å‡»</option>
                    <option value="input">è¾“å…¥</option>
                    <option value="fill">å¡«å……</option>
                    <option value="hover">æ‚¬åœ</option>
                    <option value="double_click">åŒå‡»</option>
                    <option value="right_click">å³é”®ç‚¹å‡»</option>
                    <option value="wait">ç­‰å¾…</option>
                    <option value="scroll">æ»šåŠ¨</option>
                    <option value="extract_text">æå–æ–‡æœ¬</option>
                </select>
            </div>
            <div class="form-group">
                <label for="stepSelectorType">å®šä½æ–¹å¼</label>
                <select id="stepSelectorType">
                    <option value="css">CSSé€‰æ‹©å™¨</option>
                    <option value="xpath">XPath</option>
                    <option value="id">ID</option>
                    <option value="class">Class</option>
                    <option value="name">Name</option>
                </select>
            </div>
            <div class="form-group">
                <label for="stepSelectorValue">é€‰æ‹©å™¨å€¼</label>
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <input type="text" id="stepSelectorValue" placeholder="ä¾‹å¦‚: #username æˆ– //input[@id='username']" style="flex: 1;">
                    <button type="button" id="startSelectBtn" class="btn btn-primary" onclick="startVisualSelection()" style="display: none;">
                        <i class="fa fa-mouse-pointer"></i> é€‰æ‹©å…ƒç´ 
                    </button>
                </div>
            </div>
            <div class="form-group">
                <label for="stepInputValue">è¾“å…¥å€¼/é¢„æœŸæ–‡æœ¬</label>
                <input type="text" id="stepInputValue" placeholder="è¾“å…¥å†…å®¹æˆ–é¢„æœŸéªŒè¯çš„æ–‡æœ¬">
            </div>
            <div class="form-group">
                <label for="stepDescription">æ­¥éª¤æè¿°</label>
                <textarea id="stepDescription" placeholder="æè¿°æ­¤æ­¥éª¤çš„ç›®çš„"></textarea>
            </div>
            <div class="iframe-switch-container">
                <label>
                    <input type="checkbox" id="stepIframeSwitch" class="rounded">
                    <span>æ˜¯å¦è¿›å…¥iframe</span>
                </label>
                <div id="stepIframeSelectorField" style="display: none;" class="iframe-selector-field">
                    <label for="stepIframeSelector">iframeé€‰æ‹©å™¨</label>
                    <input type="text" id="stepIframeSelector" placeholder="ä¾‹å¦‚: #myFrame æˆ– iframe[src='...']">
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closeCreateStepModal()" class="btn btn-secondary">å–æ¶ˆ</button>
                <button onclick="createStep()" class="btn btn-primary">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <!-- ç¼–è¾‘æ­¥éª¤æ¨¡æ€æ¡† -->
    <div id="editStepModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ç¼–è¾‘æµ‹è¯•æ­¥éª¤</h3>
            </div>
            <div class="form-group">
                <label for="editStepAction">æ“ä½œç±»å‹ *</label>
                <select id="editStepAction" onchange="toggleEditActionFields()">
                    <option value="navigate">å¯¼èˆª</option>
                    <option value="click">ç‚¹å‡»</option>
                    <option value="input">è¾“å…¥</option>
                    <option value="fill">å¡«å……</option>
                    <option value="hover">æ‚¬åœ</option>
                    <option value="double_click">åŒå‡»</option>
                    <option value="right_click">å³é”®ç‚¹å‡»</option>
                    <option value="wait">ç­‰å¾…</option>
                    <option value="scroll">æ»šåŠ¨</option>
                    <option value="extract_text">æå–æ–‡æœ¬</option>
                </select>
            </div>
            <div class="form-group">
                <label for="editStepSelectorType">å®šä½æ–¹å¼</label>
                <select id="editStepSelectorType">
                    <option value="css">CSSé€‰æ‹©å™¨</option>
                    <option value="xpath">XPath</option>
                    <option value="id">ID</option>
                    <option value="class">Class</option>
                    <option value="name">Name</option>
                </select>
            </div>
            <div class="form-group">
                <label for="editStepSelectorValue">é€‰æ‹©å™¨å€¼</label>
                <input type="text" id="editStepSelectorValue" placeholder="ä¾‹å¦‚: #username æˆ– //input[@id='username']">
            </div>
            <div class="form-group">
                <label for="editStepInputValue">è¾“å…¥å€¼/é¢„æœŸæ–‡æœ¬</label>
                <input type="text" id="editStepInputValue" placeholder="è¾“å…¥å†…å®¹æˆ–é¢„æœŸéªŒè¯çš„æ–‡æœ¬">
            </div>
            <div class="form-group">
                <label for="editStepDescription">æ­¥éª¤æè¿°</label>
                <textarea id="editStepDescription" placeholder="æè¿°æ­¤æ­¥éª¤çš„ç›®çš„"></textarea>
            </div>
            <div class="iframe-switch-container">
                <label>
                    <input type="checkbox" id="editStepIframeSwitch" class="rounded">
                    <span>æ˜¯å¦è¿›å…¥iframe</span>
                </label>
                <div id="editStepIframeSelectorField" style="display: none;" class="iframe-selector-field">
                    <label for="editStepIframeSelector">iframeé€‰æ‹©å™¨</label>
                    <input type="text" id="editStepIframeSelector" placeholder="ä¾‹å¦‚: #myFrame æˆ– iframe[src='...']">
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closeEditStepModal()" class="btn btn-secondary">å–æ¶ˆ</button>
                <button onclick="updateStep()" class="btn btn-primary">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <script>
        let currentCaseId = null;
        let currentCaseName = '';
        let currentEditingStepId = null;
        let currentProjectId = null;
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function getCaseIdFromSession() {
            return sessionStorage.getItem('currentCaseId');
        }
        
        function getProjectIdFromUrl() {
            const path = window.location.pathname;
            const parts = path.split('/');
            return parts[2];
        }
        
        async function loadCaseInfo() {
            currentCaseId = getCaseIdFromSession();
            
            if (!currentCaseId) {
                alert('æœªæ‰¾åˆ°ç”¨ä¾‹ä¿¡æ¯ï¼Œè¯·å…ˆé€‰æ‹©æµ‹è¯•ç”¨ä¾‹');
                window.location.href = '/list_projects';
                return;
            }
            
            try {
                const response = await fetch(`/api/cases/${currentCaseId}`);
                const data = await response.json();
                
                if (data.test_case) {
                    currentCaseName = data.test_case.name;
                    currentProjectId = data.test_case.project_id;
                    document.getElementById('caseInfo').textContent = `ç”¨ä¾‹: ${escapeHtml(currentCaseName)}`;
                } else {
                    document.getElementById('caseInfo').textContent = `ç”¨ä¾‹: æœªçŸ¥ç”¨ä¾‹`;
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨ä¾‹ä¿¡æ¯å¤±è´¥:', error);
                document.getElementById('caseInfo').textContent = `ç”¨ä¾‹: æœªçŸ¥ç”¨ä¾‹`;
            }
        }
        
        async function loadSteps() {
            if (!currentCaseId) return;
            
            try {
                const response = await fetch(`/api/cases/${currentCaseId}/steps`);
                const data = await response.json();
                
                const stepsList = document.getElementById('stepsList');
                
                if (data.steps && data.steps.length > 0) {
                    stepsList.innerHTML = '<div class="steps-list" id="stepsListContainer"></div>';
                    const stepsListContainer = document.getElementById('stepsListContainer');
                    
                    data.steps.forEach((step, index) => {
                        const stepItem = document.createElement('div');
                        stepItem.className = 'step-item';
                        stepItem.id = `step-${step.id}`;
                        
                        let actionText = '';
                        switch (step.action) {
                            case 'navigate': actionText = 'å¯¼èˆª'; break;
                            case 'click': actionText = 'ç‚¹å‡»'; break;
                            case 'input': actionText = 'è¾“å…¥'; break;
                            case 'fill': actionText = 'å¡«å……'; break;
                            case 'hover': actionText = 'æ‚¬åœ'; break;
                            case 'double_click': actionText = 'åŒå‡»'; break;
                            case 'right_click': actionText = 'å³é”®ç‚¹å‡»'; break;
                            case 'wait': actionText = 'ç­‰å¾…'; break;
                            case 'scroll': actionText = 'æ»šåŠ¨'; break;
                            case 'extract_text': actionText = 'æå–æ–‡æœ¬'; break;
                            default: actionText = step.action;
                        }
                        
                        stepItem.innerHTML = `
                            <div class="step-number">${index + 1}</div>
                            <div class="step-content">
                                <h4>${step.description || actionText}</h4>
                                <div class="step-details">
                                    ${step.selector_type ? `<div><strong>å®šä½æ–¹å¼:</strong> ${escapeHtml(step.selector_type)}</div>` : ''}
                                    ${step.selector_value ? `<div><strong>é€‰æ‹©å™¨:</strong> ${escapeHtml(step.selector_value)}</div>` : ''}
                                    ${step.input_value ? `<div><strong>è¾“å…¥å€¼:</strong> ${escapeHtml(step.input_value)}</div>` : ''}
                                    ${step.description ? `<div><strong>æè¿°:</strong> ${escapeHtml(step.description)}</div>` : ''}
                                    ${step.enter_iframe ? `<div><strong>è¿›å…¥iframe:</strong> æ˜¯</div>` : ''}
                                    ${step.iframe_selector ? `<div><strong>iframeé€‰æ‹©å™¨:</strong> ${escapeHtml(step.iframe_selector)}</div>` : ''}
                                </div>
                            </div>
                            <div class="step-actions">
                                <button onclick="editStep(${step.id})" class="btn btn-sm btn-secondary">ç¼–è¾‘</button>
                                <button onclick="deleteStep(${step.id})" class="btn btn-sm btn-danger">åˆ é™¤</button>
                            </div>
                        `;
                        
                        stepsListContainer.appendChild(stepItem);
                    });
                } else {
                    stepsList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“</div>
                            <div class="empty-state-text">è¯¥æµ‹è¯•ç”¨ä¾‹æš‚æ— æ­¥éª¤</div>
                            <button onclick="showCreateStepModal()" class="btn btn-primary">æ·»åŠ ç¬¬ä¸€ä¸ªæ­¥éª¤</button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('åŠ è½½æµ‹è¯•æ­¥éª¤å¤±è´¥:', error);
                document.getElementById('stepsList').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">âŒ</div>
                        <div class="empty-state-text">åŠ è½½æµ‹è¯•æ­¥éª¤å¤±è´¥</div>
                        <button onclick="loadSteps()" class="btn btn-primary">é‡æ–°åŠ è½½</button>
                    </div>
                `;
            }
        }
        
        function showCreateStepModal() {
            document.getElementById('createStepModal').classList.add('active');
            document.getElementById('stepAction').value = 'click';
            document.getElementById('stepSelectorType').value = 'css';
            document.getElementById('stepSelectorValue').value = '';
            document.getElementById('stepInputValue').value = '';
            document.getElementById('stepDescription').value = '';
            document.getElementById('stepIframeSwitch').checked = false;
            document.getElementById('stepIframeSelector').value = '';
            document.getElementById('stepIframeSelectorField').style.display = 'none';
            toggleActionFields();
        }
        
        function closeCreateStepModal() {
            document.getElementById('createStepModal').classList.remove('active');
        }
        
        function showEditStepModal(step) {
            currentEditingStepId = step.id;
            document.getElementById('editStepModal').classList.add('active');
            document.getElementById('editStepAction').value = step.action;
            document.getElementById('editStepSelectorType').value = step.selector_type || 'css';
            document.getElementById('editStepSelectorValue').value = step.selector_value || '';
            document.getElementById('editStepInputValue').value = step.input_value || '';
            document.getElementById('editStepDescription').value = step.description || '';
            document.getElementById('editStepIframeSwitch').checked = step.enter_iframe || false;
            document.getElementById('editStepIframeSelector').value = step.iframe_selector || '';
            document.getElementById('editStepIframeSelectorField').style.display = (step.enter_iframe || false) ? 'block' : 'none';
            toggleEditActionFields();
        }
        
        function closeEditStepModal() {
            document.getElementById('editStepModal').classList.remove('active');
            currentEditingStepId = null;
        }
        
        function toggleActionFields() {
            const action = document.getElementById('stepAction').value;
            const selectorTypeField = document.querySelector('label[for="stepSelectorType"]').parentElement;
            const selectorValueField = document.querySelector('label[for="stepSelectorValue"]').parentElement;
            const inputValueField = document.querySelector('label[for="stepInputValue"]').parentElement;
            const startSelectBtn = document.getElementById('startSelectBtn');
            
            if (action === 'navigate' || action === 'scroll') {
                selectorTypeField.style.display = 'none';
                selectorValueField.style.display = 'none';
                inputValueField.style.display = 'block';
                document.querySelector('label[for="stepInputValue"]').textContent = 'URL (å¯¼èˆª) / æ–¹å‘ (æ»šåŠ¨)';
                if (startSelectBtn) startSelectBtn.style.display = 'none';
            } else if (action === 'input' || action === 'fill') {
                selectorTypeField.style.display = 'block';
                selectorValueField.style.display = 'block';
                inputValueField.style.display = 'block';
                document.querySelector('label[for="stepInputValue"]').textContent = 'è¾“å…¥å€¼';
                if (startSelectBtn) startSelectBtn.style.display = 'none';
            } else if (action === 'extract_text') {
                selectorTypeField.style.display = 'block';
                selectorValueField.style.display = 'block';
                inputValueField.style.display = 'block';
                document.querySelector('label[for="stepInputValue"]').textContent = 'é¢„æœŸæ–‡æœ¬ (å¯é€‰)';
                if (startSelectBtn) startSelectBtn.style.display = 'inline-block';
            } else {
                selectorTypeField.style.display = 'block';
                selectorValueField.style.display = 'block';
                inputValueField.style.display = 'block';
                document.querySelector('label[for="stepInputValue"]').textContent = 'é™„åŠ ä¿¡æ¯ (å¯é€‰)';
                if (startSelectBtn) startSelectBtn.style.display = 'none';
            }
        }
        
        function toggleEditActionFields() {
            const action = document.getElementById('editStepAction').value;
            const selectorTypeField = document.querySelector('label[for="editStepSelectorType"]').parentElement;
            const selectorValueField = document.querySelector('label[for="editStepSelectorValue"]').parentElement;
            const inputValueField = document.querySelector('label[for="editStepInputValue"]').parentElement;
            
            if (action === 'navigate' || action === 'scroll') {
                selectorTypeField.style.display = 'none';
                selectorValueField.style.display = 'none';
                inputValueField.style.display = 'block';
                document.querySelector('label[for="editStepInputValue"]').textContent = 'URL (å¯¼èˆª) / æ–¹å‘ (æ»šåŠ¨)';
            } else if (action === 'input' || action === 'fill') {
                selectorTypeField.style.display = 'block';
                selectorValueField.style.display = 'block';
                inputValueField.style.display = 'block';
                document.querySelector('label[for="editStepInputValue"]').textContent = 'è¾“å…¥å€¼';
            } else if (action === 'extract_text') {
                selectorTypeField.style.display = 'block';
                selectorValueField.style.display = 'block';
                inputValueField.style.display = 'block';
                document.querySelector('label[for="editStepInputValue"]').textContent = 'é¢„æœŸæ–‡æœ¬ (å¯é€‰)';
            } else {
                selectorTypeField.style.display = 'block';
                selectorValueField.style.display = 'block';
                inputValueField.style.display = 'block';
                document.querySelector('label[for="editStepInputValue"]').textContent = 'é™„åŠ ä¿¡æ¯ (å¯é€‰)';
            }
        }
        
        // å¤„ç†iframeå¼€å…³çš„æ˜¾ç¤º/éšè—é€»è¾‘
        document.addEventListener('DOMContentLoaded', function() {
            // ä¸ºåˆ›å»ºæ­¥éª¤æ¨¡æ€æ¡†çš„iframeå¼€å…³æ·»åŠ äº‹ä»¶ç›‘å¬
            const stepIframeSwitch = document.getElementById('stepIframeSwitch');
            if (stepIframeSwitch) {
                stepIframeSwitch.addEventListener('change', function() {
                    const stepIframeSelectorField = document.getElementById('stepIframeSelectorField');
                    if (stepIframeSelectorField) {
                        stepIframeSelectorField.style.display = this.checked ? 'block' : 'none';
                    }
                });
            }
            
            // ä¸ºç¼–è¾‘æ­¥éª¤æ¨¡æ€æ¡†çš„iframeå¼€å…³æ·»åŠ äº‹ä»¶ç›‘å¬
            const editStepIframeSwitch = document.getElementById('editStepIframeSwitch');
            if (editStepIframeSwitch) {
                editStepIframeSwitch.addEventListener('change', function() {
                    const editStepIframeSelectorField = document.getElementById('editStepIframeSelectorField');
                    if (editStepIframeSelectorField) {
                        editStepIframeSelectorField.style.display = this.checked ? 'block' : 'none';
                    }
                });
            }
        });
        
        // å¯è§†åŒ–é€‰æ‹©åŠŸèƒ½
        let isSelecting = false;
        
        function startVisualSelection() {
            isSelecting = true;
            
            // 1. è·å–å½“å‰ç”¨ä¾‹ID
            const caseId = currentCaseId;
            
            // 2. è·å–å½“å‰ç”¨ä¾‹çš„æ­¥éª¤æ•°æ®
            console.log('æ­£åœ¨è·å–ç”¨ä¾‹æ­¥éª¤ï¼Œcase_id:', caseId);
            fetch(`/api/cases/${caseId}/steps`)
            .then(response => {
                console.log('è·å–æ­¥éª¤å“åº”çŠ¶æ€:', response.status);
                if (!response.ok) {
                    throw new Error('è·å–æ­¥éª¤å¤±è´¥ï¼ŒçŠ¶æ€ç : ' + response.status);
                }
                return response.json();
            })
            .then(stepsData => {
                // 3. æŸ¥æ‰¾å¯¼èˆªæ­¥éª¤å¹¶æå–URL
                let targetUrl = '';
                if (stepsData.steps && stepsData.steps.length > 0) {
                    const navigateStep = stepsData.steps.find(step => step.action === 'navigate');
                    if (navigateStep) {
                        targetUrl = navigateStep.url || navigateStep.input_value || '';
                    }
                }
                console.log('æå–åˆ°çš„å¯¼èˆªURL:', targetUrl);
                
                // 4. è°ƒç”¨åç«¯APIå¯åŠ¨å¯è§†åŒ–é€‰æ‹©ï¼Œå¹¶ä¼ é€’å¯¼èˆªURL
                console.log('æ­£åœ¨å¯åŠ¨å¯è§†åŒ–é€‰æ‹©ï¼Œç›®æ ‡URL:', targetUrl);
                return fetch('/api/start_visual_selection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ url: targetUrl })
                });
            })
            .then(response => {
                console.log('å¯åŠ¨é€‰æ‹©å“åº”çŠ¶æ€:', response.status);
                console.log('å“åº”ç±»å‹:', response.headers.get('content-type'));
                if (!response.ok) {
                    throw new Error('å¯åŠ¨é€‰æ‹©å¤±è´¥ï¼ŒçŠ¶æ€ç : ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    console.log('å¯è§†åŒ–é€‰æ‹©å·²å¯åŠ¨');
                    // å¼€å§‹ç›‘å¬å…ƒç´ é€‰æ‹©äº‹ä»¶
                    startListeningForSelection();
                } else {
                    alert('å¯åŠ¨å¯è§†åŒ–é€‰æ‹©å¤±è´¥: ' + data.error);
                    stopVisualSelection();
                }
            })
            .catch(error => {
                console.error('å¯åŠ¨å¯è§†åŒ–é€‰æ‹©æ—¶å‡ºé”™:', error);
                alert('å¯åŠ¨å¯è§†åŒ–é€‰æ‹©æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message);
                stopVisualSelection();
            });
        }
        
        function stopVisualSelection() {
            isSelecting = false;
            
            // è°ƒç”¨åç«¯APIåœæ­¢å¯è§†åŒ–é€‰æ‹©
            fetch('/api/stop_visual_selection', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('å¯è§†åŒ–é€‰æ‹©å·²åœæ­¢');
                    // åœæ­¢ç›‘å¬å…ƒç´ é€‰æ‹©äº‹ä»¶
                    stopListeningForSelection();
                }
            })
            .catch(error => {
                console.error('åœæ­¢å¯è§†åŒ–é€‰æ‹©æ—¶å‡ºé”™:', error);
            });
        }
        
        function startListeningForSelection() {
            // å¯åŠ¨è½®è¯¢ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å…ƒç´ è¢«é€‰æ‹©
            const pollInterval = setInterval(() => {
                if (!isSelecting) {
                    clearInterval(pollInterval);
                    return;
                }
                
                fetch('/api/check_selected_element')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.selected_element) {
                        // å…ƒç´ å·²è¢«é€‰æ‹©ï¼Œå¡«å……åˆ°è¡¨å•
                        fillElementToForm(data.selected_element);
                        stopVisualSelection();
                        clearInterval(pollInterval);
                    }
                })
                .catch(error => {
                    console.error('æ£€æŸ¥é€‰æ‹©å…ƒç´ æ—¶å‡ºé”™:', error);
                });
            }, 1000); // æ¯ç§’è½®è¯¢ä¸€æ¬¡
        }
        
        function stopListeningForSelection() {
            // åœæ­¢è½®è¯¢
        }
        
        // è‡ªå®šä¹‰æ¨¡æ€å¯¹è¯æ¡†åŠŸèƒ½
        function showCustomAlert(message) {
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨æ¨¡æ€å¯¹è¯æ¡†ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»º
            let modal = document.getElementById('customAlertModal');
            if (!modal) {
                // åˆ›å»ºæ¨¡æ€å¯¹è¯æ¡†HTMLç»“æ„
                const modalHTML = `
                    <div id="customAlertModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full text-center">
                            <div class="mb-4 text-gray-700">${message}</div>
                            <button id="customAlertClose" class="btn btn-primary">
                                ç¡®å®š
                            </button>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                modal = document.getElementById('customAlertModal');
                
                // æ·»åŠ å…³é—­æŒ‰é’®äº‹ä»¶
                document.getElementById('customAlertClose').addEventListener('click', function() {
                    modal.classList.add('hidden');
                    setTimeout(() => {
                        modal.remove();
                    }, 300);
                });
                
                // æ·»åŠ ç‚¹å‡»èƒŒæ™¯å…³é—­äº‹ä»¶
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        modal.classList.add('hidden');
                        setTimeout(() => {
                            modal.remove();
                        }, 300);
                    }
                });
            } else {
                // æ›´æ–°ç°æœ‰æ¨¡æ€å¯¹è¯æ¡†çš„æ¶ˆæ¯
                modal.querySelector('div').textContent = message;
                modal.classList.remove('hidden');
            }
        }
        
        function fillElementToForm(elementInfo) {
            // å¡«å……å…ƒç´ ä¿¡æ¯åˆ°è¡¨å•
            document.getElementById('stepSelectorType').value = elementInfo.selector_type || 'css';
            document.getElementById('stepSelectorValue').value = elementInfo.selector_value || '';
            
            // ä¼˜å…ˆä½¿ç”¨å…ƒç´ çš„valueå±æ€§ï¼Œç„¶åæ˜¯text_content
            let elementValue = '';
            if (elementInfo.attributes && elementInfo.attributes.value) {
                elementValue = elementInfo.attributes.value;
            } else if (elementInfo.text_content) {
                elementValue = elementInfo.text_content;
            }
            
            if (elementValue) {
                document.getElementById('stepInputValue').value = elementValue;
            }
            
            console.log('å…ƒç´ ä¿¡æ¯å·²å¡«å……åˆ°è¡¨å•:', elementInfo);
        showCustomAlert('å…ƒç´ é€‰æ‹©æˆåŠŸï¼Œå·²è‡ªåŠ¨å¡«å……åˆ°è¡¨å•ï¼');
        }
        
        async function createStep() {
            const action = document.getElementById('stepAction').value;
            const selectorType = document.getElementById('stepSelectorType').value;
            const selectorValue = document.getElementById('stepSelectorValue').value.trim();
            const inputValue = document.getElementById('stepInputValue').value.trim();
            const description = document.getElementById('stepDescription').value.trim();
            const enterIframe = document.getElementById('stepIframeSwitch').checked;
            const iframeSelector = document.getElementById('stepIframeSelector').value.trim();
            
            if (!action) {
                alert('è¯·é€‰æ‹©æ“ä½œç±»å‹');
                return;
            }
            
            try {
                const response = await fetch('/api/steps', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        case_id: currentCaseId,
                        action: action,
                        selector_type: selectorType,
                        selector_value: selectorValue,
                        input_value: inputValue,
                        description: description,
                        enter_iframe: enterIframe,
                        iframe_selector: iframeSelector
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('æµ‹è¯•æ­¥éª¤æ·»åŠ æˆåŠŸï¼');
                    closeCreateStepModal();
                    loadSteps();
                } else {
                    alert('æ·»åŠ å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('æ·»åŠ æµ‹è¯•æ­¥éª¤æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message);
            }
        }
        
        async function editStep(stepId) {
            try {
                const response = await fetch(`/api/steps/${stepId}`);
                const data = await response.json();
                
                if (data.step) {
                    showEditStepModal(data.step);
                } else {
                    alert('è·å–æ­¥éª¤ä¿¡æ¯å¤±è´¥');
                }
            } catch (error) {
                alert('è·å–æ­¥éª¤ä¿¡æ¯æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message);
            }
        }
        
        async function updateStep() {
            const action = document.getElementById('editStepAction').value;
            const selectorType = document.getElementById('editStepSelectorType').value;
            const selectorValue = document.getElementById('editStepSelectorValue').value.trim();
            const inputValue = document.getElementById('editStepInputValue').value.trim();
            const description = document.getElementById('editStepDescription').value.trim();
            const enterIframe = document.getElementById('editStepIframeSwitch').checked;
            const iframeSelector = document.getElementById('editStepIframeSelector').value.trim();
            
            if (!action) {
                alert('è¯·é€‰æ‹©æ“ä½œç±»å‹');
                return;
            }
            
            try {
                const response = await fetch(`/api/steps/${currentEditingStepId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: action,
                        selector_type: selectorType,
                        selector_value: selectorValue,
                        input_value: inputValue,
                        description: description,
                        enter_iframe: enterIframe,
                        iframe_selector: iframeSelector
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('æµ‹è¯•æ­¥éª¤æ›´æ–°æˆåŠŸï¼');
                    closeEditStepModal();
                    loadSteps();
                } else {
                    alert('æ›´æ–°å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('æ›´æ–°æµ‹è¯•æ­¥éª¤æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message);
            }
        }
        
        async function deleteStep(stepId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæµ‹è¯•æ­¥éª¤å—ï¼Ÿ')) {
                try {
                    const response = await fetch(`/api/steps/${stepId}`, {
                        method: 'DELETE'
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        alert('æµ‹è¯•æ­¥éª¤åˆ é™¤æˆåŠŸï¼');
                        loadSteps();
                    } else {
                        alert('åˆ é™¤å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                    }
                } catch (error) {
                    alert('åˆ é™¤æµ‹è¯•æ­¥éª¤æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message);
                }
            }
        }
        
        async function runTestCase() {
            try {
                const response = await fetch(`/api/cases/${currentCaseId}/run`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('æµ‹è¯•ç”¨ä¾‹è¿è¡ŒæˆåŠŸï¼\nçŠ¶æ€: ' + data.status + '\nè€—æ—¶: ' + data.duration + 'ç§’');
                } else {
                    alert('è¿è¡Œå¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('è¿è¡Œæµ‹è¯•ç”¨ä¾‹æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message);
            }
        }
        
        function backToCases() {
            if (currentProjectId) {
                window.location.href = `/list_cases_v2/${currentProjectId}`;
            } else {
                window.location.href = '/list_projects';
            }
        }
        
        document.addEventListener('DOMContentLoaded', async function() {
            await loadCaseInfo();
            loadSteps();
        });
    </script>
</body>
</html>