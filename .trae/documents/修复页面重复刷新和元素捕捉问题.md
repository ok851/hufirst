## 问题分析

### 1. 页面重复刷新问题

* **原因**：

  * `_setup_event_listeners` 方法在页面导航事件中被重复调用

  * 没有使用 `window.eventListenersAdded` 标志检查，导致事件监听器被多次添加

  * 页面导航过程中多次调用事件监听器设置，引发页面刷新

### 2. 元素捕捉问题

* **原因**：

  * 复合组件（如复选框/单选框）的处理逻辑可能存在问题

  * 事件监听器可能被多次添加，导致事件被重复触发

  * 元素选择器生成逻辑可能需要进一步优化

## 修复方案

### 1. 修复页面重复刷新问题

* **修改** **`_setup_event_listeners`** **方法**：

  * 添加 `window.eventListenersAdded` 标志检查，避免重复添加事件监听器

  * 在添加事件监听器前检查标志，添加后设置标志

* **修改** **`_on_page_navigated`** **方法**：

  * 添加页面加载状态检查，确保只在页面完全加载后才重新设置事件监听器

  * 避免在页面导航过程中多次调用事件监听器设置

### 2. 修复元素捕捉问题

* **优化事件监听器添加逻辑**：

  * 确保每个事件监听器只被添加一次

  * 使用事件委托机制，减少事件监听器数量

* **优化复合组件处理逻辑**：

  * 改进复选框/单选框等复合组件的元素定位逻辑

  * 确保正确识别和定位复合组件的根元素

* **优化元素选择器生成**：

  * 进一步完善 `generateFullPath` 函数，增加更多稳定属性支持

  * 优化选择器生成算法，提高选择器的唯一性和稳定性

### 3. 清理代码

* **清理** **`record_script.html`**：

  * 删除被注释掉的代码和未使用的事件监听器

  * 优化页面结构，提高页面性能

## 实施步骤

1. **修改** **`playwright_automation.py`**：

   * 更新 `_setup_event_listeners` 方法，添加事件监听器重复添加检查

   * 更新 `_on_page_navigated` 方法，添加页面加载状态检查

   * 优化事件监听器添加逻辑

2. **优化** **`generateFullPath`** **和** **`generateSelector`** **函数**：

   * 改进复合组件处理逻辑

   * 增加更多稳定属性支持

   * 优化选择器生成算法

3. **清理** **`record_script.html`**：

   * 删除未使用的事件监听器和被注释掉的代码

   * 优化页面结构

4. **测试修复效果**：

   * 测试页面是否不再无故刷新

   * 测试元素捕捉是否正常工作

   * 测试录制和回放功能是否正常

## 预期效果

* 页面不再无故重复刷新

* 元素捕捉成功率提高

* 事件监听器只被添加一次，避免事件重复触发

* 代码结构更清晰，性能更好

